

<!DOCTYPE html>
<html lang="th">
<head>

  <!-- Performance + SEO meta injected by assistant -->
  <meta name="description" content="Admin panel for Sideline Chiang Mai ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå, ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
  <meta name="theme-color" content="#4f46e5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
  <style id="critical-css">
    /* Critical CSS for faster FCP (assistant injected) */
    html,body{height:100%;margin:0;padding:0;font-family:'Sarabun',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    .focus-ring:focus{outline:3px solid rgba(79,70,229,0.16);outline-offset:2px}
    img{max-width:100%;height:auto;display:block}
  </style>


<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Admin SidelineCM (Titanium Edition)</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* üìå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Variables: Pink/Purple Gradient */
:root{
  /* ‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô gradient: Pink ‡πÅ‡∏•‡∏∞ Purple */
  --grad-1: #ec4899; /* Pink */
  --grad-2: #a855f7; /* Purple */
  --soft: rgba(255,255,255,.7);
  --color-success-grad: linear-gradient(90deg, #10b981, #059669); /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SEO score ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
}

.motion-pop{ animation: motion-pop .22s ease-out both; }
@keyframes motion-pop{ 0%{ transform: scale(.98); opacity: 0 } 100%{ transform: none; opacity: 1 } }
.motion-fade{ animation: motion-fade .28s ease-out both; }
@keyframes motion-fade{ from{ opacity: 0 } to{ opacity: 1 } }
.gradient-text{ background: linear-gradient(90deg, var(--grad-1), var(--grad-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
.glass{ background: var(--soft); backdrop-filter: blur(12px); }
.btn-primary{ border-radius:9999px; padding:.7rem 1.2rem; font-weight:600; color:#fff;
  background: linear-gradient(90deg, var(--grad-1), var(--grad-2));
  box-shadow: 0 10px 24px rgba(168,85,247,.35);
  transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
}
.btn-primary:hover{ transform: translateY(-1px); filter:brightness(1.06); }
.link{ color:#a855f7; font-weight:600 }
.link:hover{ text-decoration: underline }
.container-pro{ max-width: 1100px; margin:0 auto; padding: 1rem; }

/* üìå ‡∏õ‡∏∏‡πà‡∏° AI Magic Button */
.btn-ai-magic {
  background: linear-gradient(90deg, #f87171 0%, #ec4899 100%); /* ‡πÅ‡∏î‡∏á‡∏≠‡∏°‡∏ä‡∏°‡∏û‡∏π > ‡∏ä‡∏°‡∏û‡∏π */
  transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
  box-shadow: 0 5px 20px rgba(236, 72, 153, 0.4);
}
.btn-ai-magic:hover { 
    transform: translateY(-1px) scale(1.01); 
    box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
}
/* SEO Bar Gradient (‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß/‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ) */
.seo-bar-good { 
    background: var(--color-success-grad);
}
/* Card Hover Effect */
.card-pro:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 70px rgba(255, 0, 128, .12), 0 10px 30px rgba(0,0,0,.08);
}
.sticky-top-pro {
    top: 20px;
}
</styles>
<styles>
  @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
  .view-container { animation: fadeInUp 0.5s ease-out forwards; }
  .modal-box { animation: scaleIn 0.3s ease-out forwards; }
  .loader-sm { border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .loader-lg { width: 60px; height: 60px; border-width: 5px; border-color: var(--color-border); border-top-color: rgb(var(--color-primary)); border-radius: 50%; animation: spin 1s linear infinite; }
  #toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 10001; display: flex; flex-direction: column; gap: 0.75rem; }
  .toast { display: flex; align-items: center; padding: 1rem; color: #fff; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); opacity: 0; transform: translateX(120%); transition: all 400ms cubic-bezier(0.4, 0, 0.2, 1); }
  .toast.show { opacity: 1; transform: translateX(0); }
  .toast-success { background-color: var(--color-success); } .toast-error { background-color: var(--color-error); } .toast-info { background-color: var(--color-info); }
  .form-input { width: 100%; padding: 0.6rem 1rem; border: 1px solid var(--color-border); border-radius: 0.5rem; transition: all 0.2s; background-color: #f9fafb; }
  .form-input:focus { outline: none; border-color: rgb(var(--color-primary)); box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.2); }
  .tag-input-container { display: flex; flex-wrap: wrap; align-items: center; padding: 0.25rem; border: 1px solid var(--color-border); border-radius: 0.5rem; transition: all 150ms ease-in-out; }
  .tag-input-container:focus-within { border-color: rgb(var(--color-primary)); box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.2); }
  .tag-item { display: inline-flex; align-items: center; background-color: rgba(var(--color-secondary), 0.1); color: rgb(var(--color-secondary)); padding: 0.25rem 0.75rem; margin: 0.25rem; border-radius: 9999px; font-weight: 500; font-size: 0.875rem; }
  .tag-remove-btn { margin-left: 0.5rem; cursor: pointer; }
  .tag-input { flex-grow: 1; border: none; outline: none; padding: 0.5rem; background: transparent; }
  .fa-spin-custom { animation: spin 1s linear infinite; }
</style>
<style>
@keyframes subtle-pop { 0%{transform:scale(.98);opacity:.0} 100%{transform:scale(1);opacity:1} }
.subtle-pop { animation: subtle-pop .25s ease-out both; }
</style>
<style>
.fade-in { animation: fade-in .25s ease-out both; }
@keyframes fade-in { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: none; } }
.card-hover:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(0,0,0,.06); }
</style>
<style>
  /* Feminine gradient /* ... (‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡πà‡∏ß‡∏ô CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ) ... */

/* --- New Styles for Polished UI --- */radient(1200px 800px at 0% 0%, rgba(255,182,193,.25), transparent),
                      radial-gradient(1200px 800px at 100% 0%, rgba(255,192,203,.2), transparent),
                      radial-gradient(1200px 800px at 100% 100%, rgba(221,160,221,.2), transparent);
  }
</style>
<style>
/* --- Ultra Pro Layout Utilities --- */
.container-pro { max-width: 1100px; margin-left: auto; margin-right: auto; padding-left: 1rem; padding-right: 1rem; }
@media (min-width: 768px){ .container-pro { padding-left: 1.25rem; padding-right: 1.25rem; } }
.card-pro { border-radius: 1.25rem; background: rgba(255,255,255,0.75); backdrop-filter: blur(12px);
            box-shadow: 0 20px 60px rgba(255, 0, 128, .08), 0 8px 24px rgba(0,0,0,.06); }
.btn-pro { border-radius: 9999px; padding: .65rem 1.2rem; font-weight: 600;
           background: linear-gradient( to right, #ec4899, #a855f7 ); color: white;
           transition: transform .15s ease, filter .2s ease, box-shadow .2s ease; }
.btn-pro:hover { filter: brightness(1.08); box-shadow: 0 10px 24px rgba(168,85,247,.35); transform: translateY(-1px); }
.input-pro { border-radius: .9rem; border: 1px solid rgba(236,72,153,.3); padding: .7rem .9rem; width: 100%;
             background: rgba(255,255,255,.9); transition: box-shadow .2s ease, border-color .2s ease; }
.input-pro:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 4px rgba(236,72,153,.15); }
.heading-pro { background: linear-gradient(90deg, #ec4899 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.section-gap { margin-top: 1rem; margin-bottom: 1rem; }
@media (min-width: 768px){ .section-gap { margin-top: 1.25rem; margin-bottom: 1.25rem; } }
</style>
<style>
#sidebar { z-index: 50; }
#deluxe-uploader, #view-content { position: relative; z-index: 1; }
header, .topbar { position: relative; z-index: 40; }
</style>
<style>
.login-hero {
  background: radial-gradient(800px 400px at 10% 0%, rgba(236,72,153,.25), transparent),
              radial-gradient(700px 500px at 100% -10%, rgba(168,85,247,.3), transparent);
}
</style>.
<style>
<style>
  main, #app, .view-container {
    margin-top: 80px !important;
  }
  header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(10, 14, 39, 0.95);
    backdrop-filter: blur(15px);
    border-bottom: 2px solid var(--pink);
    padding: 1rem 0;
    box-shadow: var(--shadow-md);
    height: 80px;
    overflow: hidden;
  }
  #sidebar {
    top: 80px;
  }
  .nav-button {
    padding: 1.5rem 2rem;
    font-size: 1.2rem;
    border-radius: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
<style>
:root{
  --grad-1: #ec4899;
  --grad-2: #a855f7;
  --soft: rgba(255,255,255,.7);
}
.motion-pop{ animation: motion-pop .22s ease-out both; }
@keyframes motion-pop{ 0%{ transform: scale(.98); opacity: 0 } 100%{ transform: none; opacity: 1 } }
.motion-fade{ animation: motion-fade .28s ease-out both; }
@keyframes motion-fade{ from{ opacity: 0 } to{ opacity: 1 } }
.gradient-text{ background: linear-gradient(90deg, var(--grad-1), var(--grad-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
.glass{ background: var(--soft); backdrop-filter: blur(12px); }
.btn-primary{ border-radius:9999px; padding:.7rem 1.2rem; font-weight:600; color:#fff;
  background: linear-gradient(90deg, var(--grad-1), var(--grad-2));
  box-shadow: 0 10px 24px rgba(168,85,247,.35);
  transition: transform .15s ease, filter .2s ease, box-shadow .2s ease;
}
.btn-primary:hover{ transform: translateY(-1px); filter:brightness(1.06); }
.link{ color:#a855f7; font-weight:600 }
.link:hover{ text-decoration: underline }
.container-pro{ max-width: 1100px; margin:0 auto; padding: 1rem; }
/* ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô sticky ‡πÅ‡∏•‡∏∞‡∏°‡∏µ padding ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
header {
  position: sticky;
  top: 0;
  z-index: 50;
  background-color: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(10px);
  padding: 1rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding-top ‡πÉ‡∏´‡πâ main ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á header ‡∏ó‡∏±‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
main {
  padding-top: 100px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á header ‡∏à‡∏£‡∏¥‡∏á */
}
</style>.
<style>
:root[data-theme="light"]{
  --bg: #fff;
  --card: rgba(255,255,255,.75);
  --text: #111827;
}
:root[data-theme="dark"]{
  --bg: #0b0b12;
  --card: rgba(17,17,27,.72);
  --text: #f3f4f6;
  --grad-1: #f472b6;
  --grad-2: #c084fc;
}
html, body { background: var(--bg); color: var(--text); }
.card-surface{ background: var(--card); backdrop-filter: blur(10px); border-radius: 1.2rem;
  box-shadow: 0 20px 50px rgba(0,0,0,.08), 0 10px 20px rgba(0,0,0,.06);
}
.blur-up{ filter: blur(12px); transform: scale(1.02); transition: filter .35s ease, transform .35s ease; }
.blur-up.lazyloaded{ filter: blur(0); transform: none; }
.toggle-wrap{ position: fixed; right: 14px; bottom: 14px; z-index: 80; }
.theme-toggle{ border-radius: 9999px; padding: .6rem .9rem; font-weight: 600; color: #fff;
  background: linear-gradient(90deg, var(--grad-1), var(--grad-2)); box-shadow: 0 10px 24px rgba(168,85,247,.35);
}
/* Drag reorder styles */
.reorder-card{ cursor: grab; }
.reorder-card:active{ cursor: grabbing; }
/* Crop modal */
#cropper-modal{ position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index: 130; }
#cropper-modal.active{ display:flex; }
#crop-box{ width: min(92vw, 900px); background: var(--card); border-radius: 1rem; padding: 1rem; }
#crop-canvas{ width: 100%; max-height: 60vh; background: #000; border-radius: .75rem; }
</style>

<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"SidelineCM Admin","url":"https://sidelinechiangmai.netlify.app","description":"Admin panel for managing profiles and images for Sideline Chiang Mai."}
</script>

</head>
<body class="app-feminine-bg">

<div id="app-wrapper">
<div class="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center z-[9999]" id="global-loader"><div class="loader-lg"></div><p class="mt-4 text-lg font-medium text-gray-600" id="loader-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô...</p></div>
<div id="toast-container"></div>
<div id="modal-root"></div>

<div class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 via-purple-500 to-fuchsia-600 p-4" id="login-container">
<div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
<div class="text-center mb-8"><h2 class="text-3xl font-bold text-gray-900">Admin Panel</h2><p class="mt-2 text-gray-500">Admin</p></div>
<form class="space-y-6" id="loginForm">
<div><label class="text-sm font-medium text-gray-700" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input class="form-input mt-1" id="email" name="email" placeholder="admin@example.com" required="" type="email" value="adariscm2@gmail.com"/></div>
<div><label class="text-sm font-medium text-gray-700" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input class="form-input mt-1" id="password" name="password" placeholder="Password" required="" type="password" value=""/></div>
<div><button class="w-full flex justify-center py-3 px-4 border border-transparent font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
<p class="text-center text-sm text-red-600 font-medium" id="login-error"></p>
</form>
</div>
</div>

<div class="hidden" id="admin-content">
<nav class="fixed top-0 left-0 h-full bg-white w-64 shadow-xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300" id="sidebar">
<div class="p-5 border-b flex items-center gap-3"><i class="fas fa-shield-halved text-2xl text-indigo-600"></i><span class="font-bold text-xl text-slate-800">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span></div>
<div class="p-4">
<h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 px-2">‡πÄ‡∏°‡∏ô‡∏π</h2>
<ul class="space-y-1">
<li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="dashboard-container"><i class="fas fa-chart-pie w-5 mr-3 text-center"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button></li>
<li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="profiles-list-container"><i class="fas fa-users w-5 mr-3 text-center"></i>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></li>
<li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-action="add" data-view="profile-form-container"><i class="fas fa-user-plus w-5 mr-3 text-center"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</button></li>
<li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="provinces-management-container"><i class="fas fa-map-marked-alt w-5 mr-3 text-center"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</button></li>
<li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="ai-container"><i class="fas fa-robot w-5 mr-3 text-center"></i>AI</button></li>
</ul>
</div>
<div class="absolute bottom-0 w-full p-4 border-t">
<div class="text-center mb-2" id="admin-user-info"></div>
<button class="w-full flex items-center justify-center gap-2 text-sm font-medium text-red-600 hover:bg-red-50 p-2 rounded-lg transition" id="logout-button"><i class="fas fa-sign-out-alt"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
</nav>
<div class="lg:ml-64 transition-all duration-300" id="main-content">
<header class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-30 lg:hidden"><div class="p-4 flex justify-between items-center"><button class="text-gray-600 text-xl w-8 h-8 flex items-center justify-center" id="menu-toggle"><i class="fas fa-bars"></i></button><span class="font-bold text-indigo-600" id="header-title">Admin Panel</span></div><div class="container-pro mt-2 mb-2 flex justify-end"><button onclick="signOut()" class="btn-primary">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div></header>
<main class="p-4 sm:p-6 lg:p-8">
<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-slate-800" id="view-title"></h1><button class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 transition" id="refresh-button"><i class="fas fa-sync-alt"></i><span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span></button></div>
<div id="view-content">
<div class="container-pro section-gap"></div>
<div class="hidden" id="ai-container">
<h1 class="text-3xl font-bold text-slate-800">AI</h1>
<p class="text-lg text-slate-600">‡πÉ‡∏ä‡πâ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</p>
<form id="ai-form">
<label for="prompt">‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:</label>
<textarea id="prompt" class="form-input"></textarea>
<button type="submit" class="btn-primary">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
</form>
<div id="ai-output"></div>
</div>
</div>
</main>
</div>
</div>
</div>




<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supabaseUrl = 'https://hgzbgpbmymoiwjpaypvl.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnemJncGJteW1vaXdqcGF5cHZsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxMDUyMDYsImV4cCI6MjA2MjY4MTIwNn0.dIzyENU-kpVD97WyhJVZF9owDVotbl1wcYgPTt9JL_8';

const supabase = createClient(supabaseUrl, supabaseKey);
const STORAGE_BUCKET = 'profile-images';

const AppState = { currentUser: null, provinces: [], allProfiles: [], filteredProfiles: [], stats: {}, currentView: 'dashboard-container', isSidebarOpen: false, isInitialized: false, profileToEdit: null };

const DOM = {
    globalLoader: document.getElementById('global-loader'),
    loaderText: document.getElementById('loader-text'),
    loginContainer: document.getElementById('login-container'),
    loginForm: document.getElementById('loginForm'),
    loginError: document.getElementById('login-error'),
    adminContent: document.getElementById('admin-content'),
    sidebar: document.getElementById('sidebar'),
    adminUserInfo: document.getElementById('admin-user-info'),
    menuToggle: document.getElementById('menu-toggle'),
    headerTitle: document.getElementById('header-title'),
    viewTitle: document.getElementById('view-title'),
    viewContent: document.getElementById('view-content'),
    refreshButton: document.getElementById('refresh-button'),
    logoutButton: document.getElementById('logout-button'),
};

const UI = {
    debounce: (func, delay) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; },
    showToast(message, type = 'success', duration = 3000) { 
        const container = document.getElementById('toast-container'); 
        const toast = document.createElement('div'); 
        const icon = { success: 'fa-check-circle', error: 'fa-exclamation-triangle', info: 'fa-info-circle' }[type]; 
        const bgColor = { success: 'bg-green-500', error: 'bg-red-600', info: 'bg-blue-500'}[type]; 
        toast.className = `flex items-center gap-3 p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 translate-x-full ${bgColor}`; 
        toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span>${message}</span>`; 
        container.appendChild(toast); 
        requestAnimationFrame(() => toast.classList.remove('translate-x-full')); 
        setTimeout(() => { toast.classList.add('translate-x-full'); toast.addEventListener('transitionend', () => toast.remove()); }, duration);
    },
    showModal(config) { 
        const { title, message, confirmText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', cancelText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å', onConfirm, isDestructive = true } = config; 
        const modalRoot = document.getElementById('modal-root'); 
        const modalId = `modal-${Date.now()}`; 
        const confirmBtnClass = isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700'; 
        modalRoot.innerHTML = `<div id="${modalId}" class="fixed inset-0 z-[10002] flex items-center justify-center p-4"><div class="fixed inset-0 bg-black/50 backdrop-blur-sm modal-backdrop"></div><div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative modal-box"><h3 class="text-xl font-bold text-gray-900">${title}</h3><div class="mt-2 text-sm text-gray-600">${message}</div><div class="mt-6 flex justify-end space-x-3"><button class="modal-cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="modal-confirm-btn px-4 py-2 text-sm font-medium text-white ${confirmBtnClass} rounded-lg">${confirmText}</button></div></div></div>`; 
        const modalEl = document.getElementById(modalId); 
        const closeModal = () => modalEl.remove(); 
        modalEl.querySelector('.modal-confirm-btn').onclick = () => { onConfirm(); closeModal(); }; 
        modalEl.querySelector('.modal-cancel-btn').onclick = closeModal; 
        modalEl.querySelector('.modal-backdrop').onclick = closeModal; 
    },
    showProfileLightbox(profile) { 
        const modalRoot = document.getElementById('modal-root'); 
        const placeholder = 'https://placehold.co/800x1000/f3f4f6/9ca3af?text=No+Image'; 
        const imageUrl = profile.imagePath ? supabase.storage.from(STORAGE_BUCKET).getPublicUrl(profile.imagePath).data.publicUrl : placeholder; 
        const provinceName = AppState.provinces.find(p => p.key === profile.provinceKey)?.nameThai || 'N/A'; 
        const modalId = `lightbox-${profile.id}`; 
        const detailItem = (icon, label, value) => value ? `<div class="flex items-start"><i class="fas fa-${icon} w-5 text-center text-indigo-500 mt-1"></i><div class="ml-3"><p class="font-semibold text-slate-800">${label}</p><p class="text-slate-600">${value}</p></div></div>` : ''; 
        const availabilityClass = { '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô': 'bg-green-100 text-green-800', '‡∏ß‡πà‡∏≤‡∏á': 'bg-green-100 text-green-800', '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß': 'bg-blue-100 text-blue-800', '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á': 'bg-red-100 text-red-800', '‡∏û‡∏±‡∏Å': 'bg-gray-100 text-gray-800' }[profile.availability] || 'bg-yellow-100 text-yellow-800'; 
        modalRoot.innerHTML = ` <div id="${modalId}" class="fixed inset-0 z-[10002] flex items-center justify-center p-4"> <div class="fixed inset-0 bg-black/60 backdrop-blur-sm lightbox-backdrop"></div> <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative modal-box flex flex-col lg:flex-row"> <button class="lightbox-close-btn absolute top-3 right-3 lg:top-4 lg:right-4 w-10 h-10 bg-black/30 hover:bg-black/50 text-white rounded-full z-10 flex items-center justify-center transition-colors"><i class="fas fa-times text-xl"></i></button> <div class="w-full lg:w-5/12 flex-shrink-0"> <img src="${imageUrl}" alt="${profile.altText || profile.name}" class="w-full h-full object-cover lg:rounded-l-2xl" onerror="this.onerror=null;this.src='${placeholder}';"> </div> <div class="p-6 lg:p-8 flex-grow overflow-y-auto"> ${profile.isfeatured ? '<span class="inline-block bg-amber-400 text-black text-xs font-bold px-3 py-1 rounded-full mb-3"><i class="fas fa-star"></i> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''} <h3 class="text-3xl font-bold text-slate-900">${profile.name || 'N/A'}</h3> <p class="text-lg text-indigo-600 font-medium">${profile.quote || ''}</p> <div class="my-6 border-t border-slate-200"></div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5 text-sm"> ${detailItem('map-marker-alt', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏û‡∏¥‡∏Å‡∏±‡∏î', `${provinceName}${profile.location ? ` (${profile.location})` : ''}`)} ${detailItem('money-bill-wave', '‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤', profile.rate)} ${detailItem('phone-alt', 'LINE ID', profile.lineId)} <div class="flex items-start"><i class="fas fa-clock w-5 text-center text-indigo-500 mt-1"></i><div class="ml-3"><p class="font-semibold text-slate-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p><span class="px-2 py-1 text-xs font-medium rounded-full ${availabilityClass}">${profile.availability || '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°'}</span></div></div> ${detailItem('ruler-combined', '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô', profile.stats)} ${detailItem('arrows-alt-v', '‡∏™‡∏π‡∏á / ‡∏´‡∏ô‡∏±‡∏Å', [profile.height, profile.weight].filter(Boolean).join(' / '))} ${detailItem('palette', '‡∏™‡∏µ‡∏ú‡∏¥‡∏ß', profile.skinTone)} ${detailItem('birthday-cake', '‡∏≠‡∏≤‡∏¢‡∏∏', profile.age)} </div> ${profile.description ? `<div class="mt-6 pt-6 border-t border-slate-200"><h4 class="font-semibold text-slate-800 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4><p class="text-slate-600 whitespace-pre-wrap">${profile.description}</p></div>` : ''} ${profile.styleTags && profile.styleTags.length > 0 ? `<div class="mt-6 pt-6 border-t border-slate-200"><h4 class="font-semibold text-slate-800 mb-2">‡∏™‡πÑ‡∏ï‡∏•‡πå</h4><div class="flex flex-wrap gap-2">${profile.styleTags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}</div></div>` : ''} </div> </div> </div>`;
        const modalEl = document.getElementById(modalId);
        const closeModal = () => modalEl.remove();
        modalEl.querySelector('.lightbox-close-btn').onclick = closeModal;
        modalEl.querySelector('.lightbox-backdrop').onclick = closeModal;
    },
    toggleButtonLoading(button, isLoading, defaultText = 'Submit') { 
        if (!button) return;
        button.disabled = isLoading;
        button.innerHTML = isLoading ? `<span class="loader-sm w-5 h-5 inline-block"></span>` : defaultText;
    },
    setActiveNav(viewId) { 
        document.querySelectorAll('.nav-button').forEach(b => {
            const isActive = b.dataset.view === viewId;
            b.classList.toggle('bg-indigo-100', isActive);
            b.classList.toggle('text-indigo-700', isActive);
            b.classList.toggle('text-slate-600', !isActive);
        });
    },
};

const Controller = {
    async initApp() {
        DOM.globalLoader.classList.remove('hidden');
        DOM.loaderText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô...";
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
            console.error("Error fetching session:", error);
            this.showLoginScreen("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
            return;
        }
        if (session) {
            AppState.currentUser = session.user;
            await this.startAdminPanel();
        } else {
            this.showLoginScreen();
        }
        supabase.auth.onAuthStateChange((_event, session) => {
            if (session && !AppState.currentUser) {
                AppState.currentUser = session.user;
                this.startAdminPanel();
            } else if (!session && AppState.currentUser) {
                AppState.currentUser = null;
                this.showLoginScreen("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            }
        });
    },

    showLoginScreen(toastMessage = null) {
        AppState.isInitialized = false;
        AppState.currentUser = null;
        DOM.adminContent.classList.add('hidden');
        DOM.loginContainer.classList.remove('hidden');
        DOM.globalLoader.classList.add('hidden');
        if (toastMessage) {
            UI.showToast(toastMessage, 'info');
        }
    },

    async startAdminPanel() {
        if (AppState.isInitialized) return;
        AppState.isInitialized = true;
        DOM.loaderText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        DOM.loginContainer.classList.add('hidden');
        DOM.adminContent.classList.remove('hidden');
        DOM.globalLoader.classList.remove('hidden');
        DOM.adminUserInfo.innerHTML = `<p class="text-sm font-semibold text-slate-800">${AppState.currentUser.email.split('@')[0]}</p>`;
        try {
            await this.fetchData();
            this.renderView('dashboard-container');
            UI.showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!', 'success');
        } catch (err) {
            DOM.viewContent.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow"><h2 class="text-xl font-bold text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2><p class="mt-2 text-red-500">${err.message}</p></div>`;
            UI.showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'error');
        } finally {
            DOM.globalLoader.classList.add('hidden');
        }
    },


    async handleLogin(e) {
        e.preventDefault();
        const form = e.target;
        const loginButton = form.querySelector('button[type="submit"]');
        UI.toggleButtonLoading(loginButton, true, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        DOM.loginError.textContent = '';
        const { error } = await supabase.auth.signInWithPassword({
            email: form.email.value,
            password: form.password.value,
        });
        if (error) {
            DOM.loginError.textContent = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            UI.showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
            UI.toggleButtonLoading(loginButton, false, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
        }
    },

    async handleLogout() {
        UI.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
        await supabase.auth.signOut();
    },

    setupEventListeners() {
        if (this.listenersInitialized) return;
        DOM.loginForm.addEventListener('submit', e => this.handleLogin(e));
        DOM.logoutButton.addEventListener('click', () => this.handleLogout());
        DOM.menuToggle.addEventListener('click', () => DOM.sidebar.classList.toggle('-translate-x-full'));
        DOM.refreshButton.addEventListener('click', async () => { UI.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'info'); await this.loadInitialData(); });
        document.body.addEventListener('click', e => {
            const navButton = e.target.closest('.nav-button');
            if (navButton) this.renderView(navButton.dataset.view, { action: navButton.dataset.action });
            const editBtn = e.target.closest('.edit-profile-btn');
            if (editBtn) this.renderView('profile-form-container', { profileId: editBtn.dataset.id });
            const deleteBtn = e.target.closest('.delete-profile-btn');
            if (deleteBtn) this.handleDeleteProfile(deleteBtn.dataset);
            const previewBtn = e.target.closest('#preview-profile-button');
            if (previewBtn) this.handlePreviewProfile();
            const profileCard = e.target.closest('.profile-card-clickable');
            if (profileCard && !e.target.closest('button')) {
                const profile = AppState.allProfiles.find(p => p.id == profileCard.dataset.id);
                if (profile) UI.showProfileLightbox(profile);
            }
            const deleteProvinceBtn = e.target.closest('.delete-province-btn');
            if (deleteProvinceBtn) this.handleDeleteProvince(deleteProvinceBtn.dataset);
        });
        this.listenersInitialized = true;
    },

    async loadInitialData() {
        await this.fetchData(); 
        const currentView = AppState.currentView;
        const currentParams = AppState.currentParams;
        this.renderView(currentView, currentParams);
    },

    // ‡πÉ‡∏ô Controller
async fetchData(force = false) {
  const lastFetchTime = AppState.lastFetchTime || '1970-01-01T00:00:00Z';

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏•‡∏±‡∏á lastFetchTime
  const profilesResponse = await supabase
    .from('profiles')
    .select('*')
    .gte('lastUpdated', lastFetchTime);
  if (profilesResponse.error) throw profilesResponse.error;

  const newProfiles = profilesResponse.data || [];

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô AppState.allProfiles
  newProfiles.forEach(p => {
    const index = AppState.allProfiles.findIndex(existing => existing.id === p.id);
    if (index !== -1) {
      AppState.allProfiles[index] = p;
    } else {
      AppState.allProfiles.push(p);
    }
  });

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï lastFetchTime ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  AppState.lastFetchTime = new Date().toISOString();

  // ‡πÇ‡∏´‡∏•‡∏î provinces ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  if (force || !Array.isArray(AppState.provinces) || AppState.provinces.length === 0) {
    const provincesResponse = await supabase.from('provinces').select('*').order('nameThai');
    if (provincesResponse.error) throw provincesResponse.error;
    AppState.provinces = provincesResponse.data || [];
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å updateStats ‡∏à‡∏≤‡∏Å Controller
  Controller.updateStats();
},
    updateStats() { 
        AppState.stats.profiles = AppState.allProfiles.length; 
        AppState.stats.featured = AppState.allProfiles.filter(p => p.isfeatured).length; 
        AppState.stats.provinces = AppState.provinces.length;
    },

    renderView(viewId, params = {}) {
        AppState.currentView = viewId;
        AppState.currentParams = params;
        DOM.viewContent.innerHTML = `<div class="flex justify-center p-16"><div class="loader-lg"></div></div>`;
        UI.setActiveNav(viewId);
        const activeNav = document.querySelector(`.nav-button[data-view="${viewId}"]`);
        if (activeNav) {
            const titleText = activeNav.textContent.trim();
            DOM.headerTitle.textContent = titleText;
            DOM.viewTitle.textContent = titleText;
        }
        if (window.innerWidth < 1024) DOM.sidebar.classList.add('-translate-x-full');
        const renderFunction = this[`render${viewId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('')}`];
        if (typeof renderFunction === 'function') {
            renderFunction.call(this, params);
        } else {
            DOM.viewContent.innerHTML = `<p>View not implemented: ${viewId}</p>`;
        }
    },

    renderDashboardContainer() { 
        const { profiles, featured, provinces } = AppState.stats;
        const statsCards = [
            { i: 'users', c: 'indigo', t: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', v: profiles },
            { i: 'star', c: 'amber', t: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', v: featured },
            { i: 'map-marked-alt', c: 'emerald', t: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', v: provinces }
        ];
        DOM.viewContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${statsCards.map(s => `<div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5"><i class="fas fa-${s.i} text-3xl text-${s.c}-500 bg-${s.c}-100 p-4 rounded-full"></i><div><p class="text-sm text-slate-500">${s.t}</p><p class="text-3xl font-bold text-slate-800">${s.v}</p></div></div>`).join('')}</div>`;
    },

    renderProfilesListContainer() { 
        DOM.viewContent.innerHTML = `<div class="space-y-6"><div class="bg-white p-4 rounded-xl shadow-md"><input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠..." class="form-input"></div><div id="profiles-grouped-list" class="space-y-8"></div></div>`; 
        this.renderGroupedProfileCards(); 
        document.getElementById('search-input').addEventListener('input', UI.debounce(() => this.renderGroupedProfileCards(), 300)); 
    },

    renderGroupedProfileCards() { 
        const listEl = document.getElementById('profiles-grouped-list'); 
        if (!listEl) return; 
        const searchTerm = document.getElementById('search-input')?.value.toLowerCase().trim() || ''; 
        const filteredProfiles = AppState.allProfiles.filter(p => !searchTerm || (p.name && p.name.toLowerCase().includes(searchTerm))); 
        let html = AppState.provinces.map(province => {
            const profilesInProvince = filteredProfiles.filter(p => p.provinceKey === province.key);
            if (profilesInProvince.length === 0) return '';
            return `<div class="province-group"><h2 class="text-2xl font-bold text-slate-800 border-b-2 border-indigo-200 pb-2 mb-4">${province.nameThai}</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${profilesInProvince.map(p => this.getProfileCardHTML(p)).join('')}</div></div>`;
        }).join('');
        listEl.innerHTML = html || `<p class="col-span-full text-center py-16 text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>`;
    },

    getProfileCardHTML(p) { 
        const provinceName = AppState.provinces.find(prov => prov.key === p.provinceKey)?.nameThai || 'N/A'; 
        const imageUrl = (p.imagePaths && p.imagePaths[0]) || p.imagePath ? supabase.storage.from(STORAGE_BUCKET).getPublicUrl((p.imagePaths && p.imagePaths[0]) || p.imagePath).data.publicUrl : 'https://placehold.co/400x500/f3f4f6/9ca3af?text=No+Image'; 
        const placeholder = 'https://placehold.co/400x500/f3f4f6/9ca3af?text=No+Image'; 
        return `<div class="bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col group profile-card-clickable cursor-pointer" data-id="${p.id}"><div class="relative aspect-[3/4]"><img src="${imageUrl}" alt="${p.altText || p.name}" class="w-full h-full object-cover transition-transform group-hover:scale-105" onerror="this.onerror=null;this.src='${placeholder}';" loading="lazy"> ${p.isfeatured ? '<div class="absolute top-3 left-3 bg-amber-400 text-black text-xs font-semibold px-3 py-1 rounded-full flex items-center gap-1.5"><i class="fas fa-star"></i>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>' : ''}</div><div class="p-3 md:p-4 flex-grow flex flex-col"><h4 class="text-base md:text-lg font-bold text-slate-800 truncate">${p.name || 'N/A'}</h4><p class="text-xs md:text-sm text-slate-500">${provinceName}</p><div class="mt-auto pt-3 md:pt-4 border-t border-slate-200/80 flex space-x-2 md:space-x-3"><button data-id="${p.id}" class="edit-profile-btn flex-1 py-1.5 md:py-2 px-2 md:px-3 text-xs md:text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button><button data-id="${p.id}" data-name="${p.name}" data-imagepath="${(p.imagePaths && p.imagePaths[0]) || p.imagePath || ''}" class="delete-profile-btn flex-1 py-1.5 md:py-2 px-2 md:px-3 text-xs md:text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">‡∏•‡∏ö</button></div></div></div>`; 
    },

async renderProfileFormContainer(params = {}) { 
        const profileId = params.profileId;
        const isEditing = !!profileId;
        let p = {};
        if (isEditing) {
            const { data, error } = await supabase.from('profiles').select('*').eq('id', profileId).single();
            if (error) { UI.showToast("‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠", "error"); return this.renderView('profiles-list-container'); }
            p = data;
        }
        const imageUrl = (p.imagePaths && p.imagePaths[0]) || p.imagePath ? supabase.storage.from(STORAGE_BUCKET).getPublicUrl((p.imagePaths && p.imagePaths[0]) || p.imagePath).data.publicUrl : null;
        const formHTML = `<div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-4xl mx-auto"><form id="profile-form" class="space-y-8"><input type="hidden" id="profile-id" value="${p.id || ''}"><input type="hidden" id="current-image-path" value="${(p.imagePaths && p.imagePaths[0]) || p.imagePath || ''}"><div><h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3><div class="flex flex-col md:flex-row gap-6 items-start"><div id="image-uploader" class="flex-shrink-0"></div><div class="flex-grow space-y-4"><label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="isFeatured" class="h-5 w-5 text-indigo-600 rounded" ${p.isfeatured ? 'checked' : ''}><span class="font-medium text-gray-700">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span></label><div><label for="availability" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label><select id="availability" class="form-input">${['‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ß‡πà‡∏≤‡∏á', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô', '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á', '‡∏û‡∏±‡∏Å'].map(s => `<option value="${s}" ${p.availability === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div></div></div></div><div><h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><div><label for="name" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠*</label><input type="text" id="name" required class="form-input" value="${p.name || ''}"></div><div>
<div class="mb-4">
  <label for="image-file-input" class="block text-sm font-medium text-gray-700 mb-1">
    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ
  </label>
  
  <div id="dropzone"
       class="border-2 border-dashed border-pink-400/60 rounded-xl p-6 text-center cursor-pointer hover:bg-pink-50 transition">
    <p class="mb-2 text-gray-500">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
    <button type="button" id="choose-images" class="btn-primary">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
    <input type="file" id="image-file-input" multiple accept="image/*" class="hidden">
  </div>

  <!-- Preview -->
  <div id="deluxe-preview" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mt-3"></div>
  
  <p class="mt-2 text-xs text-gray-400">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô .webp ‡∏Ç‡∏ô‡∏≤‡∏î 1200px / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 80% ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  </p>
</div>
<label for="age" class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" id="age" class="form-input" value="${p.age || ''}"></div><div><label for="stats" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</label><input type="text" id="stats" class="form-input" value="${p.stats || ''}" placeholder="36-24-35"></div><div><label for="height" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏π‡∏á (cm)</label><input type="text" id="height" class="form-input" value="${p.height || ''}"></div><div><label for="weight" class="block text-sm font-medium text-slate-700 mb-1">‡∏´‡∏ô‡∏±‡∏Å (kg)</label><input type="text" id="weight" class="form-input" value="${p.weight || ''}"></div><div><label for="skinTone" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏µ‡∏ú‡∏¥‡∏ß</label><input type="text" id="skinTone" class="form-input" value="${p.skinTone || ''}" placeholder="‡∏Ç‡∏≤‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á"></div></div></div><div><h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="provinceKey" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠*</label><select id="provinceKey" required class="form-input">${AppState.provinces.map(prov => `<option value="${prov.key}" ${p.provinceKey === prov.key ? 'selected' : ''}>${prov.nameThai}</option>`).join('')}</select></div><div><label for="location" class="block text-sm font-medium text-slate-700 mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏¢‡πà‡∏≠‡∏¢)</label><input type="text" id="location" class="form-input" value="${p.location || ''}" placeholder="‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô, ‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°"></div><div><label for="rate" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="text" id="rate" class="form-input" value="${p.rate || ''}" placeholder="1500/1"></div><div><label for="lineId" class="block text-sm font-medium text-slate-700 mb-1">LINE ID</label><input type="text" id="lineId" class="form-input" value="${p.lineId || ''}"></div></div></div><div><h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h3><div class="space-y-4"><div><label for="quote" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ</label><input type="text" id="quote" class="form-input" value="${p.quote || ''}"></div><div><label for="description" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="description" rows="4" class="form-input">${p.description || ''}</textarea></div><div><label class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡πÑ‡∏ï‡∏•‡πå (Tags)</label><div id="tag-input-component"></div></div><div><label for="altText" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Alt Text)</label><input type="text" id="altText" class="form-input" value="${p.altText || ''}" placeholder="‡∏ô‡πâ‡∏≠‡∏á‡πÉ‡∏¢‡πÑ‡∏´‡∏° ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"></div></div></div><div class="pt-5 flex justify-between items-center border-t"><button type="button" class="nav-button px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200" data-view="profiles-list-container">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><div class="flex items-center space-x-3"><button type="button" id="preview-profile-button" class="px-4 py-2.5 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200"><i class="fas fa-eye mr-2"></i>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button><button type="submit" id="save-profile-button" class="flex items-center justify-center px-6 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 btn-pro">${isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á'}</button></div></div></form></div>`;
        DOM.viewContent.innerHTML = formHTML;
        this.initImageUploader(imageUrl);
        this.initTagInput(p.styleTags || []);
        document.getElementById('profile-form').addEventListener('submit', e => this.handleProfileFormSubmit(e));
    },

    initImageUploader(imageUrl) {
      const uploaderEl = document.getElementById('image-uploader');
      uploaderEl.innerHTML = `
        <div class="space-y-3">
          <div id="dz" class="relative w-full min-h-[12rem] rounded-xl p-6 border-2 border-dashed border-slate-300 bg-slate-50
                             hover:border-indigo-400 transition cursor-pointer">
            <input type="file" id="image-file-input" accept="image/*" multiple
                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <div class="pointer-events-none text-center">
              <p class="text-sm text-slate-600 font-medium">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
              <p class="text-xs text-slate-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô .webp ‡∏Ç‡∏ô‡∏≤‡∏î 1200px / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 85%</p>
            </div>
          </div>
          <div id="multi-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </div>
      `;

      const fileInput = document.getElementById('image-file-input');
      const dz = document.getElementById('dz');
      const previewGrid = document.getElementById('multi-preview');

      const renderPreview = (files) => {
        previewGrid.innerHTML = '';
        files.forEach(f => {
          const url = URL.createObjectURL(f);
          const card = document.createElement('div');
          card.className = 'relative rounded-xl overflow-hidden shadow bg-white';
          card.innerHTML = `<img src="${url}" class="w-full h-40 object-cover" alt="">
                            <div class="absolute bottom-0 inset-x-0 bg-black/40 text-white text-xs p-1 truncate">${f.name}</div>`;
          previewGrid.appendChild(card);
        });
      };

      dz.addEventListener('click', () => fileInput.click());
      dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('border-indigo-400'); });
      dz.addEventListener('dragleave', () => dz.classList.remove('border-indigo-400'));
      dz.addEventListener('drop', e => {
        e.preventDefault();
        dz.classList.remove('border-indigo-400');
        const dtFiles = Array.from(e.dataTransfer.files || []).filter(f => /^image\//.test(f.type));
        if (!dtFiles.length) return;
        const dataTransfer = new DataTransfer();
        dtFiles.forEach(f => dataTransfer.items.add(f));
        fileInput.files = dataTransfer.files;
        renderPreview(dtFiles);
      });

      fileInput.addEventListener('change', e => {
        renderPreview(Array.from(e.target.files || []));
      });

      if (imageUrl) {
        previewGrid.innerHTML = `
          <div class="relative rounded-xl overflow-hidden shadow bg-white">
            <img src="${imageUrl}" class="w-full h-40 object-cover" alt="">
            <div class="absolute bottom-0 inset-x-0 bg-black/40 text-white text-xs p-1 truncate">‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
          </div>`;
      }
    },

    initTagInput(initialTags = []) { 
        const container = document.getElementById('tag-input-component');
        let tags = [...initialTags];
        const render = () => {
            container.innerHTML = `<div class="tag-input-container bg-white">${tags.map(tag => `<div class="tag-item"><span>${tag}</span><i class="fas fa-times tag-remove-btn" data-tag="${tag}"></i></div>`).join('')}<input type="text" class="tag-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter..."></div>`;
            container.querySelector('.tag-input').addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    e.preventDefault();
                    tags.push(e.target.value.trim());
                    tags = [...new Set(tags)];
                    render();
                }
            });
            container.querySelectorAll('.tag-remove-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    tags = tags.filter(t => t !== e.target.dataset.tag);
                    render();
                });
            });
        };
        render();
    },

    async handleProfileFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const profileId = form.querySelector('#profile-id').value;
        const isEditing = !!profileId;
        const saveButton = form.querySelector('#save-profile-button');
        UI.toggleButtonLoading(saveButton, true, isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á');

        try {
            const fileInput = form.querySelector('#image-file-input');
            let imagePath = form.querySelector('#current-image-path').value || '';
            let uploadedPaths = [];

            const files = Array.from(fileInput?.files || []);

            if (!isEditing && !files.length && !imagePath) {
                throw new Error('‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ');
            }

            if (files.length) {
                UI.showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${files.length} ‡πÑ‡∏ü‡∏•‡πå...`, 'info');

                const toWebp1200 = async (file) => {
                    const bitmap = await createImageBitmap(file);
                    const scale = bitmap.width > 1200 ? 1200 / bitmap.width : 1;
                    const w = Math.round(bitmap.width * scale);
                    const h = Math.round(bitmap.height * scale);
                    const canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.filter = 'contrast(1.06) saturate(1.06) brightness(1.02)';
                    ctx.drawImage(bitmap, 0, 0, w, h);
                    const blob = await new Promise(res => canvas.toBlob(res, 'image/webp', 0.85));
                    return new File([blob], (file.name.replace(/\.[^.]+$/, '') || 'img') + '.webp', { type: 'image/webp' });
                };

                for (const f of files) {
                    const webpFile = await toWebp1200(f);
                    const fileName = `${Date.now()}-${Math.random().toString(36).slice(2,8)}.webp`;
                    const { data, error } = await supabase.storage.from(STORAGE_BUCKET).upload(fileName, webpFile, { upsert: true });
                    if (error) throw new Error(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
                    uploadedPaths.push(data.path);
                }

                imagePath = uploadedPaths[0];
            }

            const profileData = this.collectFormData(form);
            if (imagePath) profileData.imagePath = imagePath;
            if (uploadedPaths.length) profileData.galleryPaths = uploadedPaths;

            let dbRes;
            if (isEditing) {
                dbRes = await supabase.from('profiles').update(profileData).eq('id', profileId).select().single();
            } else {
                dbRes = await supabase.from('profiles').insert(profileData).select().single();
            }
            if (dbRes.error) throw new Error(dbRes.error.message);

            UI.showToast(isEditing ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            this.renderView('profiles-list-container');
        } catch (err) {
            console.error(err);
            UI.showToast(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        } finally {
            UI.toggleButtonLoading(saveButton, false, isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á');
        }
    },

    collectFormData(form) {
        const styleTags = Array.from(form.querySelectorAll('.tag-item span')).map(span => span.textContent);
        return {
            name: form.querySelector('#name').value.trim(), age: parseInt(form.querySelector('#age').value) || null,
            height: form.querySelector('#height').value.trim(), weight: form.querySelector('#weight').value.trim(),
            stats: form.querySelector('#stats').value.trim(), skinTone: form.querySelector('#skinTone').value.trim(),
            provinceKey: form.querySelector('#provinceKey').value, location: form.querySelector('#location').value.trim(),
            rate: form.querySelector('#rate').value.trim(), availability: form.querySelector('#availability').value,
            lineId: form.querySelector('#lineId').value.trim(), quote: form.querySelector('#quote').value.trim(),
            description: form.querySelector('#description').value.trim(), 
            altText: form.querySelector('#altText').value.trim() || form.querySelector('#name').value.trim(),
            isfeatured: form.querySelector('#isFeatured').checked, styleTags, lastUpdated: new Date().toISOString()
        };
    },

    handlePreviewProfile() {
        const form = document.getElementById('profile-form');
        if (!form) return;
        const profileData = this.collectFormData(form);
        const currentImagePath = form.querySelector('#current-image-path').value;
        const imageFile = form.querySelector('#image-file-input').files[0];
        if (imageFile) {
            profileData.imagePath = URL.createObjectURL(imageFile);
        } else {
            profileData.imagePath = currentImagePath;
        }
        UI.showProfileLightbox(profileData);
    },

    handleDeleteProfile({ id, name, imagepath }) { 
        UI.showModal({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            message: `‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á <strong>${name}</strong>? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
            onConfirm: async () => {
                UI.showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö ${name}...`, 'info');
                try {
                    const { error } = await supabase.from('profiles').delete().eq('id', id);
                    if (error) throw error;
                    if (imagepath && imagepath !== 'null' && imagepath.trim() !== '') {
                        const { error: storageError } = await supabase.storage.from(STORAGE_BUCKET).remove([imagepath]);
                        if (storageError) console.warn("Failed to delete image from storage:", storageError.message);
                    }
                    UI.showToast('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await this.fetchData();
                    this.renderView(AppState.currentView, AppState.currentParams);
                } catch (error) {
                    UI.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`, "error");
                }
            }
        });
    },

    renderProvincesManagementContainer() { 
        DOM.viewContent.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-xl shadow-lg"><h4 class="text-lg font-semibold text-indigo-700 mb-4 border-b pb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</h4><form id="add-province-form" class="space-y-4"><div><label for="province-name-thai" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏ó‡∏¢)*</label><input type="text" id="province-name-thai" required class="form-input"></div><div><label for="province-key" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏µ‡∏¢‡πå (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)*</label><input type="text" id="province-key" required class="form-input" placeholder="english-no-space"><p class="text-xs text-slate-500 mt-1">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ</p></div><button type="submit" id="add-province-btn" class="w-full py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></form></div><div class="bg-white p-6 rounded-xl shadow-lg"><h4 class="text-lg font-semibold text-indigo-700 mb-4 border-b pb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4><div class="overflow-x-auto">${AppState.provinces.length === 0 ? '<p class="text-center py-8 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>' : `<table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th><th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">‡∏Ñ‡∏µ‡∏¢‡πå</th><th class="px-4 py-3 text-right"></th></tr></thead><tbody class="bg-white divide-y divide-slate-200">${AppState.provinces.map(p => `<tr><td class="px-4 py-3 text-sm text-slate-700">${p.nameThai}</td><td class="px-4 py-3 text-sm font-mono text-slate-500">${p.key}</td><td class="px-4 py-3 text-right"><button data-id="${p.id}" data-name="${p.nameThai}" class="delete-province-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></td></tr>`).join('')}</tbody></table>`}</div></div></div>`;
        document.getElementById('add-province-form').addEventListener('submit', e => this.handleAddProvince(e));
    },

    async handleAddProvince(e) { 
        e.preventDefault();
        const form = e.target;
        const nameThai = form.querySelector('#province-name-thai').value.trim();
        const key = form.querySelector('#province-key').value.trim().toLowerCase().replace(/\s+/g, '-');
        if (!nameThai || !key) { return UI.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); }
        const saveButton = form.querySelector('#add-province-btn');
        UI.toggleButtonLoading(saveButton, true, '‡πÄ‡∏û‡∏¥‡πà‡∏°');
        try {
            const { error } = await supabase.from('provinces').insert([{ nameThai, key }]);
            if (error) throw error;
            UI.showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            form.reset();
            await this.fetchData();
            this.renderView('provinces-management-container');
        } catch (error) {
            UI.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        } finally {
            UI.toggleButtonLoading(saveButton, false, '‡πÄ‡∏û‡∏¥‡πà‡∏°');
        }
    },

    handleDeleteProvince({ id, name }) { 
        UI.showModal({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            message: `‡∏à‡∏∞‡∏•‡∏ö <strong>${name}</strong>?`,
            onConfirm: async () => {
                try {
                    const { error } = await supabase.from('provinces').delete().eq('id', id);
                    if (error) throw error;
                    UI.showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    await this.fetchData();
                    this.renderView('provinces-management-container');
                } catch (error) {
                    UI.showToast(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
                }
            }
        });
    }
};

document.addEventListener('DOMContentLoaded', () => {
    Controller.setupEventListeners();
    Controller.initApp();
});
</script>
<script src="//cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>
<script>
// === Multi-image Preview Enhancer ===
(function(){
    function byId(id){ return document.getElementById(id); }
    const input = byId('image-file-input');
    const preview = document.getElementById('multi-preview');
    if (!input || !preview) return;
    preview.innerHTML = '';
    input.addEventListener('change', () => {
        preview.innerHTML = '';
        const files = Array.from(input.files || []);
        files.forEach(file => {
            const url = URL.createObjectURL(file);
            const card = document.createElement('div');
            card.className = 'relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01]';
            const img = document.createElement('img');
            img.src = url;
            img.alt = file.name;
            img.className = 'w-full h-32 object-cover';
            const badge = document.createElement('div');
            badge.className = 'absolute top-2 right-2 text-xs px-2 py-1 rounded-full bg-black/60 text-white backdrop-blur';
            badge.textContent = (file.type || '').replace('image/','').toUpperCase();
            card.appendChild(img);
            card.appendChild(badge);
            preview.appendChild(card);
        });
    }, { once:false });
})();
</script>
<script>
// === Rehydrate multi-preview from existing imagePaths/imagePath ===
(function(){
    const preview = document.getElementById('multi-preview');
    if (!preview) return;
    const form = document.getElementById('profile-form') || document.querySelector('form');
    if (!form) return;
    const currentSingle = form.querySelector('#current-image-path')?.value;
    let embedded = null;
    try { embedded = window.__CURRENT_PROFILE__ || null; } catch(_) {}
    const paths = (embedded && embedded.imagePaths) ? embedded.imagePaths
                  : (currentSingle ? [currentSingle] : []);
    if (paths && paths.length) {
        preview.innerHTML = '';
        paths.forEach(p => {
            const card = document.createElement('div');
            card.className = 'relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01]';
            const img = document.createElement('img');
            img.src = (typeof CDN_PUBLIC_URL !== 'undefined' ? CDN_PUBLIC_URL : '') + p;
            img.className = 'w-full h-32 object-cover';
            card.appendChild(img);
            preview.appendChild(card);
        });
    }
})();
</script>
<script>
// === Auto-close sidebar on navigation (mobile) ===
(function(){
    const mq = window.matchMedia('(max-width: 1024px)');
    const closeSidebar = () => {
        try {
            AppState.isSidebarOpen = false;
            document.documentElement.classList.remove('overflow-hidden');
            const sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.add('-translate-x-full');
        } catch(_) {}
    };
    const nav = document.getElementById('sidebar') || document;
    nav.addEventListener('click', (e) => {
        const el = e.target.closest('a,[data-nav],[data-action="navigate"]');
        if (!el) return;
        if (mq.matches) setTimeout(closeSidebar, 50);
    });
    const origRenderView = (window.App && App.renderView) || null;
    if (origRenderView) {
        App.renderView = (...args) => {
            const res = origRenderView.apply(App, args);
            if (mq.matches) closeSidebar();
            return res;
        };
    }
})();
</script>
<script>
// === Advanced Multi-Preview: drag & drop, remove items, limit, de-dup ===
(function(){
    const input = document.getElementById('image-file-input');
    const preview = document.getElementById('multi-preview');
    if (!input || !preview) return;
    const dropArea = input.closest('.relative') || preview.parentElement;
    const MAX_FILES = 20;
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    
    const dedup = (files) => {
        const seen = new Set();
        const out = [];
        for (const f of files) {
            const key = `${f.name}|${f.size}|${f.lastModified}`;
            if (!seen.has(key)) {
                seen.add(key); out.push(f);
            }
        }
        return out;
    };
    const rebuildInputFiles = (files) => {
        const dt = new DataTransfer();
        files.forEach(f => dt.items.add(f));
        input.files = dt.files;
    };
    const render = () => {
        preview.innerHTML = '';
        const files = Array.from(input.files || []);
        files.forEach((file, idx) => {
            const url = URL.createObjectURL(file);
            const card = document.createElement('div');
            card.className = 'group relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01] subtle-pop';
            const img = document.createElement('img');
            img.src = url;
            img.alt = file.name;
            img.className = 'w-full h-32 object-cover';
            const topbar = document.createElement('div');
            topbar.className = 'absolute inset-x-0 top-0 flex justify-between p-2 opacity-0 group-hover:opacity-100 transition';
            const badge = document.createElement('div');
            badge.className = 'text-[10px] px-2 py-1 rounded-full bg-black/60 text-white backdrop-blur';
            badge.textContent = (file.type || '').replace('image/','').toUpperCase();
            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'text-white bg-red-500/80 hover:bg-red-600 text-xs px-2 py-1 rounded';
            del.textContent = '‡∏•‡∏ö';
            del.addEventListener('click', () => {
                const arr = Array.from(input.files);
                arr.splice(idx, 1);
                rebuildInputFiles(arr);
                render();
            });
            topbar.appendChild(badge);
            topbar.appendChild(del);
            card.appendChild(img);
            card.appendChild(topbar);
            preview.appendChild(card);
        });
    };
    const accept = (files) => {
        let current = Array.from(input.files || []);
        const newList = [];
        for (const f of files) {
            if (!/^image\//i.test(f.type)) continue;
            if (f.size > MAX_SIZE) {
                UI && UI.showToast ? UI.showToast(`‡πÑ‡∏ü‡∏•‡πå ${f.name} ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB`, 'warning') : console.warn('oversize', f.name);
                continue;
            }
            newList.push(f);
        }
        current = current.concat(newList);
        current = dedup(current).slice(0, MAX_FILES);
        rebuildInputFiles(current);
        render();
    };
    input.addEventListener('change', () => accept(Array.from(input.files || [])));
    if (dropArea) {
        ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, e => { e.preventDefault(); dropArea.classList.add('ring-2','ring-indigo-400'); }));
        ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e => { e.preventDefault(); dropArea.classList.remove('ring-2','ring-indigo-400'); }));
        dropArea.addEventListener('drop', (e)=>{
            const files = Array.from(e.dataTransfer.files || []);
            accept(files);
        });
    }
    render();
})();
</script>
<!-- === Theme toggle === -->
<div class="toggle-wrap">
  <button id="theme-toggle" class="theme-toggle">‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°</button>
</div>
<script>
(function(){
  const btn = document.getElementById('theme-toggle');
  if (!btn) return;
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) root.setAttribute('data-theme', saved);
  else root.setAttribute('data-theme', 'light');
  btn.addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme') === 'dark' ? 'light':'dark';
    root.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
  });
})();
</script>
<!-- === Lazy load images === -->
<script>
(function(){
  function onLoad(e){ e.target.classList.add('lazyloaded'); }
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('img').forEach(img=>{
      img.loading = 'lazy';
      img.classList.add('blur-up');
      if (img.complete) { img.classList.add('lazyloaded'); }
      else { img.addEventListener('load', onLoad, { once:true }); }
    });
  });
})();
</script>
<!-- === Cropper modal === -->
<div id="cropper-modal">
  <div id="cropper-box" class="card-surface">
    <h3 class="text-lg font-semibold mb-2">‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
    <canvas id="crop-canvas"></canvas>
    <div class="flex flex-wrap gap-2 mt-3">
      <button class="btn-primary" data-aspect="1">1:1</button>
      <button class="btn-primary" data-aspect="0.8">4:5</button>
      <button class="btn-primary" data-aspect="1.7777777778">16:9</button>
      <button id="crop-apply" class="btn-primary">‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏õ</button>
      <button id="crop-cancel" class="btn-primary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>
<script>
(function(){
  const input = document.getElementById('image-file-input');
  const preview = document.getElementById('deluxe-preview');
  if (!input || !preview) return;

  function rebuild(files){ const dt = new DataTransfer(); files.forEach(f => dt.items.add(f)); input.files = dt.files; }
  function equip(){
    Array.from(preview.children).forEach((card, i)=>{
      card.classList.add('reorder-card');
      card.setAttribute('draggable','true');
      if (!card.querySelector('.btn-crop')){
        const bar = card.querySelector('.absolute.inset-x-0.top-0');
        const cropBtn = document.createElement('button');
        cropBtn.type = 'button';
        cropBtn.textContent = '‡∏Ñ‡∏£‡∏≠‡∏õ';
        cropBtn.className = 'btn-crop text-white bg-indigo-500/90 hover:bg-indigo-600 text-xs px-2 py-1 rounded';
        bar.appendChild(cropBtn);
        cropBtn.addEventListener('click', ()=> openCrop(i));
      }
      card.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', i.toString());
        ev.dataTransfer.effectAllowed = 'move';
      });
      card.addEventListener('dragover', ev => { ev.preventDefault(); ev.dataTransfer.dropEffect = 'move'; });
      card.addEventListener('drop', ev => {
        ev.preventDefault();
        const from = parseInt(ev.dataTransfer.getData('text/plain'),10);
        const arr = Array.from(input.files);
        const [moved] = arr.splice(from,1);
        arr.splice(i,0,moved);
        rebuild(arr);
        input.dispatchEvent(new Event('change'));
      });
    });
  }
  const modal = document.getElementById('cropper-modal');
  const canvas = document.getElementById('crop-canvas');
  const ctx = canvas.getContext('2d');
  let cropState = { img:null, aspect:1, fileIndex:0, bmp:null, sel:{x:0,y:0,w:0,h:0} };
  function openCrop(index){
    const file = Array.from(input.files)[index];
    cropState.fileIndex = index;
    createImageBitmap(file, { imageOrientation:'from-image' }).then(bmp => {
      cropState.bmp = bmp;
      canvas.width = Math.min(1024, bmp.width);
      canvas.height = Math.min(600, Math.round(canvas.width * (bmp.height/bmp.width)));
      drawCrop();
      modal.classList.add('active');
    });
  }
  function drawCrop(){
    const bmp = cropState.bmp;
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
    const asp = cropState.aspect || 1;
    let w = canvas.width * 0.8;
    let h = w / asp;
    if (h > canvas.height * 0.8){ h = canvas.height * 0.8; w = h * asp; }
    const x = (canvas.width - w)/2, y = (canvas.height - h)/2;
    cropState.sel = {x,y,w,h};
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(0,0,canvas.width, y);
    ctx.fillRect(0,y+h,canvas.width, canvas.height-(y+h));
    ctx.fillRect(0,y,w,y+h-y);
    ctx.fillRect(x+w,y,canvas.width-(x+w),h);
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.strokeRect(x,y,w,h);
  }
  document.querySelectorAll('#cropper-box [data-aspect]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ cropState.aspect = parseFloat(btn.dataset.aspect); drawCrop(); });
  });
  document.getElementById('crop-cancel').addEventListener('click', ()=> modal.classList.remove('active'));
  document.getElementById('crop-apply').addEventListener('click', async ()=>{
    const scale = cropState.bmp.width / canvas.width;
    const s = cropState.sel;
    const cw = Math.round(s.w * scale), ch = Math.round(s.h * scale);
    const c = document.createElement('canvas'); c.width = cw; c.height = ch;
    c.getContext('2d').drawImage(cropState.bmp, Math.round(s.x*scale), Math.round(s.y*scale), cw, ch, 0,0,cw,ch);
    const blob = await new Promise(res => c.toBlob(res, 'image/webp', 0.95));
    const file = new File([blob], 'cropped.webp', { type:'image/webp', lastModified: Date.now() });
    const arr = Array.from(input.files);
    arr.splice(cropState.fileIndex, 1, file);
    rebuild(arr);
    input.dispatchEvent(new Event('change'));
    modal.classList.remove('active');
  });
  const observer = new MutationObserver(equip);
  observer.observe(preview, { childList:true, subtree:false });
  equip();
})();
</script>
<!-- Dashboard stats -->
<div class="container-pro section-gap">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="card-surface p-4">
<div class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
<div id="stat-total" class="text-3xl font-bold gradient-text">‚Äì</div>
</div>
<div class="card-surface p-4">
<div class="text-sm text-gray-500">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</div>
<canvas id="chart-uploads" height="120"></canvas>
</div>
<div class="card-surface p-4">
<div class="text-sm text-gray-500">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå (webp/jpg/png)</div>
<canvas id="chart-ratio" height="120"></canvas>
</div>
</div>
</div>
<script>
(function(){
  function barChart(canvas, labels, values){
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    const max = Math.max(...values, 1);
    const pad = 24, bw = (W - pad*2) / values.length * 0.7;
    labels.forEach((lb, i) => {
      const x = pad + i * ((W-pad*2)/values.length) + 6;
      const h = (H - pad*2) * (values[i]/max);
      const y = H - pad - h;
      ctx.fillStyle = '#a855f7';
      ctx.fillRect(x, y, bw, h);
      ctx.fillStyle = '#6b7280'; ctx.font = '10px sans-serif';
      ctx.fillText(lb, x, H - pad + 12);
    });
  }
  function pieChart(canvas, counts){
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0,0,W,H);
    const total = Object.values(counts).reduce((a,b)=>a+b,0) || 1;
    let start = -Math.PI/2;
    const colors = ['#ec4899','#a855f7','#06b6d4','#22c55e','#f97316'];
    Object.keys(counts).forEach((k, idx)=>{
      const val = counts[k];
      const ang = (val/total) * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(W/2,H/2);
      ctx.arc(W/2,H/2, Math.min(W,H)/2 - 10, start, start+ang);
      ctx.closePath();
      ctx.fillStyle = colors[idx%colors.length];
      ctx.fill();
      start += ang;
    });
  }
  const uploads7 = [3,5,2,6,4,8,5];
  const ratio = { webp: 12, jpg: 4, png: 2 };
  const c1 = document.getElementById('chart-uploads');
  const c2 = document.getElementById('chart-ratio');
  if (c1) { c1.width = c1.clientWidth; barChart(c1, ['‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™','‡∏≠‡∏≤'], uploads7); }
  if (c2) { c2.width = c2.clientWidth; pieChart(c2, ratio); }
  const total = document.getElementById('stat-total');
  if (total) total.textContent = window.__TOTAL_PROFILES__ || '‚Äî';
})();
</script>
<script>
(function(){
  const search = document.getElementById('search-input');
  if (!search) return;
  const list = document.querySelectorAll('.profile-card');
  const on = () => {
    const q = search.value.toLowerCase();
    list.forEach(el => {
      const text = (el.dataset.name||'') + ' ' + (el.dataset.tags||'');
      el.style.display = text.toLowerCase().includes(q) ? '' : 'none';
    });
  };
  search.addEventListener('input', on);
  on();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.getElementById('choose-images');
  const input = document.getElementById('image-file-input');
  if (btn && input) btn.addEventListener('click', ()=> input.click());
});
</script>

<!-- Assistant enhancement: performance, UX, accessibility, and stability -->
<script>
(function(){
  'use strict';
  // Utilities
  window.__assist = window.__assist || {};
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function debounce(fn, delay=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),delay); }; }
  function safeCall(fn){ try{ fn(); }catch(e){ console.error('assist.safeCall',e); } }

  // Improve image loading: set loading=lazy & decoding=async where missing
  safeCall(()=>{
    $$('img').forEach(img=>{
      if(!img.hasAttribute('loading')) img.setAttribute('loading','lazy');
      if(!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
      if(!img.alt) img.alt = img.getAttribute('data-alt') || 'Sideline profile image';
    });
  });

  // Debounce search inputs
  safeCall(()=>{
    const search = $('#search-input') || document.querySelector('input[placeholder*="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"]');
    if(search){
      const orig = search.oninput;
      search.addEventListener('input', debounce((e)=>{
        // call existing handler if any by dispatching input event
        const ev = new Event('input',{bubbles:true});
        search.dispatchEvent(ev);
      }, 300));
    }
  });

  // Accessibility: ensure modals can be closed by ESC and focus management
  safeCall(()=>{
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        $$('#modal-root > *').forEach(m=>m.remove());
        const crop = document.getElementById('cropper-modal');
        if(crop) crop.classList.remove('active');
      }
    });
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.matches('.lightbox-backdrop, .modal-backdrop')){
        const p = e.target.closest('#modal-root');
        if(p) p.innerHTML='';
      }
    });
  });

  // Form auto-save draft (localStorage) for profile form to prevent data loss
  safeCall(()=>{
    const form = document.getElementById('profile-form');
    if(!form) return;
    const key = 'sideline_admin_profile_draft_v1';
    // restore
    try{
      const data = localStorage.getItem(key);
      if(data){
        const obj = JSON.parse(data);
        Object.keys(obj).forEach(k=>{
          const el = form.querySelector('#'+k);
          if(el && !el.value) el.value = obj[k];
        });
      }
    }catch(e){}
    // save on input (debounced)
    form.addEventListener('input', debounce(()=>{
      const inputs = form.querySelectorAll('input,textarea,select');
      const out = {};
      inputs.forEach(i=>{ if(i.id) out[i.id]=i.value; });
      try{ localStorage.setItem(key, JSON.stringify(out)); }catch(e){}
    }, 500));
    // clear on successful submit (listen for button click)
    const saveBtn = form.querySelector('#save-profile-button');
    if(saveBtn) saveBtn.addEventListener('click', ()=>{ try{ localStorage.removeItem(key);}catch(e){} });
  });

  // Prevent double form submit across app
  safeCall(()=>{
    document.addEventListener('submit', function(e){
      const btn = e.submitter || e.target.querySelector('button[type="submit"]');
      if(btn && btn.disabled) { e.preventDefault(); return; }
      if(btn) btn.disabled = true;
      setTimeout(()=>{ if(btn) btn.disabled = false; }, 2000);
    }, true);
  });

  // Improve toast container behavior: ensure stacking and aria-live
  safeCall(()=>{
    const container = document.getElementById('toast-container');
    if(container) container.setAttribute('aria-live','polite');
  });

  // Performance hint: defer non-critical scripts (mark scripts with data-defer="assistant") 
  safeCall(()=>{
    $$('script[data-defer="assistant"]').forEach(s=>{
      try{ const src = s.getAttribute('src'); if(src){ const sc = document.createElement('script'); sc.src = src; sc.defer = true; document.body.appendChild(sc); s.remove(); } }
      catch(e){}
    });
  });

  // Small visual polish: respect prefers-reduced-motion
  safeCall(()=>{
    if(window.matchMedia('(prefers-reduced-motion: reduce)').matches){
      document.documentElement.classList.add('reduce-motion');
    }
  });

  // Log assistant boot
  console.info('Assistant enhancements applied: ', new Date().toISOString());
})();

</script>

<script>
document.querySelector('[data-view="ai-container"]').addEventListener('click', () => {
renderAIContainer();
});

async function renderAIContainer() {
const form = document.getElementById('ai-form');
form.addEventListener('submit', async (e) => {
e.preventDefault();
const prompt = document.getElementById('prompt').value;
try {
const response = await fetch('/generate', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ prompt }),
});
const data = await response.json();
document.getElementById('ai-output').textContent = data.text;
} catch (error) {
console.error(error);
}
});
}
</script>

<!-- ================================================================================== -->
<!-- üéµ ULTIMATE ADMIN WIDGET (Final Fixed: Video Priority Mode) -->
<!-- ================================================================================== -->

<style>
  /* --- Widget Style --- */
  :root {
    --widget-size: 60px;
    --widget-bg: rgba(255, 255, 255, 0.95);
    --widget-blur: blur(20px) saturate(180%);
    --widget-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    --primary-color: #FF6F61;
  }

  #admin-assistive-root {
    position: fixed; z-index: 999999; top: 75%; left: 80%;
    touch-action: none; user-select: none;
  }
  
  .assistive-btn {
    width: var(--widget-size); height: var(--widget-size);
    background: var(--widget-bg);
    backdrop-filter: var(--widget-blur); -webkit-backdrop-filter: var(--widget-blur);
    border-radius: 50%;
    box-shadow: var(--widget-shadow);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; position: relative;
    color: var(--primary-color); font-size: 26px;
    transition: transform 0.1s;
  }
  .assistive-btn:active { transform: scale(0.9); }

  .playing-pulse { animation: pulse 1.5s infinite; color: #D667C3; }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(214, 103, 195, 0.6); }
    70% { box-shadow: 0 0 0 15px rgba(214, 103, 195, 0); }
    100% { box-shadow: 0 0 0 0 rgba(214, 103, 195, 0); }
  }

  .control-center-panel {
    position: fixed; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 380px;
    background: #ffffff;
    border-radius: 24px;
    box-shadow: 0 50px 100px rgba(0,0,0,0.4);
    padding: 20px;
    opacity: 0; pointer-events: none; z-index: 100001;
    transition: all 0.25s ease;
    display: flex; flex-direction: column; gap: 12px;
    max-height: 85vh;
    overflow: hidden;
  }
  .control-center-panel.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

  /* üé¨ Video Container (‡πÅ‡∏Å‡πâ‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ display: block ‡∏ú‡πà‡∏≤‡∏ô JS ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) */
  #video-display-area {
    position: relative; 
    width: 100%; 
    background: #000;
    border-radius: 14px; 
    overflow: hidden; 
    display: none; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */
    min-height: 220px; 
    justify-content: center; 
    align-items: center;
    z-index: 20; /* ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠ */
  }
  
  #video-display-area iframe { width: 100%; aspect-ratio: 16/9; border: none; }
  #video-display-area video { width: 100%; max-height: 250px; }

  /* üéµ Music Display */
  #music-display-area { text-align: center; padding: 10px; display: block; }
  
  .music-cover {
    width: 120px; height: 120px; margin: 0 auto 10px;
    border-radius: 20px; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  .music-cover img { width: 100%; height: 100%; object-fit: cover; }

  /* üìÇ Playlist View */
  .playlist-view {
    display: none; flex-direction: column; gap: 8px;
    max-height: 300px; overflow-y: auto;
    padding-right: 5px;
  }
  .playlist-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px; background: #f8f9fa; border-radius: 10px;
    cursor: pointer; transition: 0.2s; border: 1px solid transparent;
  }
  .playlist-item:hover { background: #f0f0f0; }
  .playlist-info { flex: 1; overflow: hidden; }
  .playlist-title { font-size: 13px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .playlist-type { font-size: 10px; color: #888; text-transform: uppercase; }

  /* Controls */
  .media-input {
    width: 100%; background: #f3f4f6; border: none;
    padding: 12px; border-radius: 12px; outline: none;
    font-size: 14px; text-align: center; color: #333;
  }
  .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  
  .preset-btn {
    padding: 10px; background: #fff; border: 1px solid #eee; border-radius: 12px;
    font-size: 12px; font-weight: 600; color: #555; cursor: pointer;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
  }
  .preset-btn:hover { background: #f9fafb; }
  .preset-btn.highlight { background: var(--primary-color); color: white; border: none; }
  .preset-btn.highlight i { color: white; }
  
  .close-btn {
    position: absolute; top: 15px; right: 15px;
    width: 30px; height: 30px; border-radius: 50%; background: #f3f4f6;
    display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10;
  }
  .back-btn {
    display: none; font-size: 12px; color: #555; cursor: pointer; margin-bottom: 5px;
  }
</style>

<!-- UI Elements -->
<div id="admin-assistive-root">
  <div class="assistive-btn" id="assistive-main-btn"><i class="fas fa-compact-disc"></i></div>
</div>

<div class="control-center-panel" id="admin-control-panel">
  <div class="close-btn" onclick="AdminOS.closePanel()"><i class="fas fa-times"></i></div>
  
  <div class="text-center">
    <h3 class="font-bold text-gray-800" id="panel-title">Media Center</h3>
    <div class="back-btn" id="playlist-back-btn" onclick="AdminOS.toggleView('player')">
      <i class="fas fa-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô
    </div>
  </div>

  <!-- PLAYER VIEW -->
  <div id="player-view-container">
    
    <!-- ‚ö†Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (YouTube/File) -->
    <div id="video-display-area"></div>
    
    <!-- üéµ ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡πÄ‡∏û‡∏•‡∏á (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠) -->
    <div id="music-display-area">
      <div class="music-cover">
        <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=400&q=80">
      </div>
      <p class="text-xs text-gray-500 mt-2" id="current-track-name">Ready to Play</p>
    </div>

    <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å URL -->
    <input type="text" class="media-input mb-3" id="media-url-input" 
           placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏´‡∏£‡∏∑‡∏≠ Video..." 
           onkeypress="if(event.key === 'Enter') AdminOS.playFromInput(this.value)">

    <div class="preset-grid">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á -->
      <button class="preset-btn highlight" style="grid-column: span 2;" 
              onclick="AdminOS.toggleView('playlist')">
        <i class="fas fa-list-ul"></i> üìÇ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
      </button>

      <button class="preset-btn" onclick="AdminOS.playMedia('https://www.youtube.com/watch?v=jfKfPfyJRdk', 'youtube', 'Lofi Girl')">
        <i class="fas fa-coffee"></i> Lofi Girl
      </button>
      
      <button class="preset-btn" onclick="document.getElementById('local-file-picker').click()">
        <i class="fas fa-folder-open"></i> ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
      </button>
      
      <button class="preset-btn" style="color:red; grid-column: span 2;" onclick="AdminOS.stopAll()">
        <i class="fas fa-stop"></i> ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô
      </button>
    </div>
  </div>

  <!-- PLAYLIST VIEW (‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏•‡∏á) -->
  <div id="playlist-view-container" class="playlist-view"></div>
  
  <input type="file" id="local-file-picker" hidden accept="video/*,audio/*" onchange="AdminOS.playLocalFile(this)">
</div>

<script>
const AdminOS = {
  // --- üíø ‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ö‡∏ô‡πÇ‡∏Æ‡∏™‡∏ï‡πå (‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ---
  myAlbum: [
    // ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô‡πÇ‡∏Æ‡∏™‡∏ï‡πå (‡πÉ‡∏™‡πà path ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å)
    { 
      title: "‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô - ‡∏ô‡πâ‡∏≠‡∏ô‡∏ô", 
      url: "./songs/‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô - ‡∏ô‡πâ‡∏≠‡∏ô‡∏ô.mp4", 
      type: "video" 
    },

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå songs ‡∏≠‡∏µ‡∏Å ‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    { 
      title: "üò∂", 
      url: "./songs/üò∂.mp4", 
      type: "video" 
    },

    // ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 2: ‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube (‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ)
    { 
      title: "‡∏ô‡∏ô‡∏ó‡πå ‡∏ò‡∏ô‡∏ô‡∏ó‡πå - ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠ (Live)", 
      url: "https://www.youtube.com/watch?v=PrlV8Q_FvjM", 
      type: "youtube" 
    }
    
  ],
  

  root: document.getElementById('admin-assistive-root'),
  btn: document.getElementById('assistive-main-btn'),
  panel: document.getElementById('admin-control-panel'),
  
  playerView: document.getElementById('player-view-container'),
  playlistView: document.getElementById('playlist-view-container'),
  backBtn: document.getElementById('playlist-back-btn'),
  panelTitle: document.getElementById('panel-title'),
  
  videoArea: document.getElementById('video-display-area'),
  musicArea: document.getElementById('music-display-area'),
  trackName: document.getElementById('current-track-name'),
  audioPlayer: new Audio(),
  isDragging: false,

  init() {
    this.setupDraggable();
    this.renderPlaylist();
    this.btn.addEventListener('click', () => {
      if (!this.isDragging) this.panel.classList.toggle('active');
    });
  },

  closePanel() { this.panel.classList.remove('active'); },

  // ‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  toggleView(view) {
    if (view === 'playlist') {
      this.playerView.style.display = 'none';
      this.playlistView.style.display = 'flex';
      this.backBtn.style.display = 'inline-block';
      this.panelTitle.innerText = "My Album";
    } else {
      this.playerView.style.display = 'block';
      this.playlistView.style.display = 'none';
      this.backBtn.style.display = 'none';
      this.panelTitle.innerText = "Media Center";
    }
  },

  renderPlaylist() {
    this.playlistView.innerHTML = '';
    this.myAlbum.forEach((item) => {
      const el = document.createElement('div');
      el.className = 'playlist-item';
      let icon = item.type === 'video' ? 'fa-video' : 'fa-youtube';
      
      el.innerHTML = `
        <i class="fas ${icon}" style="color:${item.type==='youtube'?'red':'#555'}"></i>
        <div class="playlist-info">
          <div class="playlist-title">${item.title}</div>
          <div class="playlist-type">${item.type}</div>
        </div>
        <i class="fas fa-play-circle" style="color:var(--primary-color)"></i>
      `;
      el.onclick = () => {
        this.playMedia(item.url, item.type, item.title);
        this.toggleView('player');
      };
      this.playlistView.appendChild(el);
    });
  },

  stopAll() {
    this.videoArea.innerHTML = '';
    this.videoArea.style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    this.musicArea.style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏Å‡πÄ‡∏û‡∏•‡∏á‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤
    this.audioPlayer.pause();
    this.btn.classList.remove('playing-pulse');
    this.trackName.innerText = "Stopped";
  },

  playFromInput(url) {
    url = url.trim();
    if (!url) return;
    let type = (url.includes('youtube') || url.includes('youtu.be')) ? 'youtube' : 'video';
    this.playMedia(url, type, 'Unknown Track');
  },

  // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏∑‡πà‡∏≠ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
  playMedia(source, type, title) {
    // 1. ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠
    this.audioPlayer.pause();
    
    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á / ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°
    this.btn.classList.add('playing-pulse');
    if(title) this.trackName.innerText = title;

    // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
    if (type === 'youtube' || type === 'video') {
      this.musicArea.style.display = 'none';  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏õ‡∏Å‡πÄ‡∏û‡∏•‡∏á!
      this.videoArea.style.display = 'flex';  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠!
    } else {
      this.musicArea.style.display = 'block';
      this.videoArea.style.display = 'none';
    }

    // 4. ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    if (type === 'youtube') {
      let vId = '';
      if (source.includes('youtu.be')) vId = source.split('/').pop().split('?')[0];
      else if (source.includes('v=')) vId = source.split('v=')[1].split('&')[0];
      
      // Iframe ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô + autoplay
      this.videoArea.innerHTML = `
        <iframe src="https://www.youtube.com/embed/${vId}?autoplay=1&playsinline=1&rel=0&controls=1" 
        allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

    } else if (type === 'video') {
      this.videoArea.innerHTML = `
        <video src="${source}" controls autoplay playsinline webkit-playsinline 
               style="width:100%; height:100%; object-fit:contain;"></video>`;

    } else {
      // Audio Only
      this.audioPlayer.src = source;
      this.audioPlayer.play();
    }
  },

  playLocalFile(input) {
    const file = input.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      const type = file.type.startsWith('video') ? 'video' : 'audio';
      this.playMedia(url, type, file.name);
    }
  },

  setupDraggable() {
    const el = this.root;
    let startX, startY, initX, initY, moved = false;
    const start = (e) => {
      const evt = e.touches ? e.touches[0] : e;
      startX = evt.clientX; startY = evt.clientY;
      const rect = el.getBoundingClientRect();
      initX = rect.left; initY = rect.top;
      moved = false; this.isDragging = false;
      el.style.transition = 'none';
      document.addEventListener('touchmove', move, {passive:false});
      document.addEventListener('touchend', end);
      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', end);
    };
    const move = (e) => {
      const evt = e.touches ? e.touches[0] : e;
      const dx = evt.clientX - startX; const dy = evt.clientY - startY;
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        if(e.cancelable) e.preventDefault();
        moved = true; this.isDragging = true;
        el.style.left = `${initX + dx}px`;
        el.style.top = `${initY + dy}px`;
      }
    };
    const end = () => {
      document.removeEventListener('touchmove', move);
      document.removeEventListener('touchend', end);
      document.removeEventListener('mousemove', move);
      document.removeEventListener('mouseup', end);
      if (moved) {
        el.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        const w = window.innerWidth;
        const rect = el.getBoundingClientRect();
        if (rect.left + rect.width/2 > w/2) el.style.left = (w - 70) + 'px';
        else el.style.left = '10px';
        setTimeout(() => this.isDragging = false, 100);
      }
    };
    el.addEventListener('touchstart', start, {passive:false});
    el.addEventListener('mousedown', start);
  }
};

AdminOS.init();
</script>
</body>
</html>