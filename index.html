<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kissmodel Admin ‚ú®</title>
  
  <meta name="description" content="Admin panel for Kissmodel.">
  <meta name="theme-color" content="#FF6F61">
  <meta property="og:image" content="https://sidelinechiangmai.netlify.app/images/adminkissmodelsocial.webp">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="icon" href="/images/favicon.svg" type="image/svg+xml">
  
<style>
  /* Critical CSS */
  html, body {
    height: 100%; margin: 0; padding: 0;
    font-family: 'Sarabun', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }
  
  /* THEME "Lavender Dusk & Electric Coral" */
  :root {
    --color-primary: 255 111 97;   /* Electric Coral */
    --color-text-main: #2E2E2E;
    --color-text-muted: #5a5a6a;
    --color-card: rgba(255, 255, 255, 0.75);
    --color-border: #E6E0FF;
    --grad-1: #FF6F61;
    --grad-2: #D667C3;
    --color-highlight: #FFEB3B;
  }
  :root[data-theme="dark"] {
    --color-text-main: #F7F5FF;
    --color-text-muted: #a8a0b5;
    --color-card: rgba(46, 36, 58, 0.7);
    --color-border: #3A3042;
    --grad-1: #FF8578;
    --grad-2: #E087D0;
  }

  /* ANIMATED "LIVING" BACKGROUND */
  @keyframes animated-aurora {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  body {
    color: var(--color-text-main);
    -webkit-font-smoothing: antialiased;
    background: linear-gradient(-45deg, #E6E0FF, #D667C3, #FF6F61, #3A3042);
    background-size: 400% 400%;
    animation: animated-aurora 20s ease infinite;
  }
  :root[data-theme="dark"] body {
    background: linear-gradient(-45deg, #1A1423, #3A3042, #E087D0, #FF8578);
    background-size: 400% 400%;
    animation: animated-aurora 20s ease infinite;
  }
  
  /* Kissmodel Logo & Title Animation */
  .kissmodel-logo {
    font-size: 1.8rem; font-weight: 700; display: inline-block; color: #fff;
    text-shadow: 0 0 5px var(--grad-1), 0 0 10px var(--grad-1), 0 0 20px var(--grad-2);
    animation: flicker 2s infinite alternate;
  }
  .kissmodel-logo .star {
    font-size: 1.2em; display: inline-block; color: var(--color-highlight);
    animation: star-glow 2s infinite ease-in-out;
    text-shadow: 0 0 10px var(--color-highlight), 0 0 20px #fff;
  }
  .dashboard-title {
    font-size: 2.5rem; font-weight: 800;
    background: linear-gradient(90deg, var(--grad-1), var(--grad-2), var(--color-highlight), var(--grad-1));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    animation: gradient-flow 5s ease infinite;
    background-size: 300% 300%;
  }
  @keyframes flicker { 0%, 100% { text-shadow: 0 0 5px var(--grad-1), 0 0 10px var(--grad-1); } 50% { text-shadow: 0 0 8px var(--grad-1), 0 0 25px var(--grad-2); } }
  @keyframes star-glow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3) rotate(15deg); } }
  @keyframes gradient-flow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

  /* Buttons with Shine Effect */
  .btn-pro, .btn-primary {
    position: relative; overflow: hidden; border-radius: 9999px;
    padding: .7rem 1.2rem; font-weight: 600; color: #fff !important;
    background: linear-gradient(90deg, var(--grad-1), var(--grad-2));
    box-shadow: 0 10px 24px rgba(var(--color-primary), 0.35);
    transition: transform .15s ease, filter .2s ease;
    border: none;
  }
  .btn-pro:hover, .btn-primary:hover { transform: translateY(-2px); filter: brightness(1.1); }
  .btn-pro::before, .btn-primary::before {
    content: ''; position: absolute; top: 0; left: -100%;
    width: 50%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s ease; transform: skewX(-25deg);
  }
  .btn-pro:hover::before, .btn-primary:hover::before { left: 150%; }

  /* General UI Styles */
  .card-surface {
    background-color: var(--color-card);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-radius: 1.25rem;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.18);
  }
  /* FIXED: Form input readability */
  .form-input {
    width: 100%; padding: 0.6rem 1rem; border: 1px solid var(--color-border);
    border-radius: 0.5rem; transition: all 0.2s ease;
    background-color: rgba(255, 255, 255, 0.6); /* More opaque */
    color: var(--color-text-main);
  }

  :root[data-theme="dark"] .form-input { background-color: rgba(0, 0, 0, 0.3); }
  .form-input:focus {
    outline: none; border-color: rgb(var(--color-primary));
    box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.2);
  }
  #sidebar, #header { background-color: transparent !important; }
  .nav-button:hover { background-color: rgba(var(--color-primary), 0.1); }
  .nav-button.active {
    background-color: rgba(var(--color-primary), 0.15);
    color: rgb(var(--color-primary)); font-weight: 600;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .loader-lg {
    width: 60px; height: 60px; border: 5px solid var(--color-border);
    border-top-color: rgb(var(--color-primary));
    border-radius: 50%; animation: spin 1s linear infinite;
  }
  
</style>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>
<!-- ... code ‡πÄ‡∏î‡∏¥‡∏° ... -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Vidstack Player (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π YouTube/Video ‡∏™‡∏ß‡∏¢‡πÜ) -->
<link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
<link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />
<script type="module" src="https://cdn.vidstack.io/player"></script>

<style>
/* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢ (Admin Widget) */
#admin-widget-root {
    position: fixed; z-index: 99999; bottom: 30px; right: 30px;
    display: flex; flex-direction: column-reverse; align-items: end; gap: 10px;
}

/* ‡∏ï‡∏±‡∏ß‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢ (Assistive Button) */
.float-btn {
    width: 60px; height: 60px;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    color: #333; font-size: 24px;
    user-select: none; touch-action: none;
}
.float-btn:hover { transform: scale(1.1); background: rgba(255,255,255,0.8); }
.float-btn:active { transform: scale(0.95); }

/* ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô (Popup Panel) */
.widget-panel {
    width: 350px;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 20px;
    padding: 15px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    transform-origin: bottom right;
    transition: all 0.3s ease;
    opacity: 0; transform: scale(0.8) translateY(20px); pointer-events: none;
    position: absolute; bottom: 80px; right: 0;
}
.widget-panel.active { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }

/* Input ‡∏™‡∏ß‡∏¢‡πÜ */
.glass-input {
    background: rgba(255,255,255,0.5); border: 1px solid #ccc;
    border-radius: 8px; padding: 8px 12px; width: 100%;
    font-size: 13px; outline: none; margin-bottom: 10px;
}
/* ‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏ß‡∏° */
.music-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  max-width: 350px; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏≠‡∏î‡∏µ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
  margin: 0 auto;
}

/* ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏£‡∏π‡∏õ‡∏õ‡∏Å (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏î‡∏≥) */
.cover-image-container {
  position: relative;
  width: 100%;
  height: 200px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.cover-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s;
}

/* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏†‡∏≤‡∏û‡∏Ç‡∏¢‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏ô */
.cover-img.spinning {
  transform: scale(1.1);
}

/* ‡∏à‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏£‡∏π‡∏õ */
.center-overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.2); /* ‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏î‡∏≥‡∏ö‡∏≤‡∏á‡πÜ */
}

/* --- ‡∏õ‡∏∏‡πà‡∏° Play ‡πÅ‡∏ö‡∏ö Neon Glass --- */
.neon-play-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.15); /* ‡πÉ‡∏™‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏à‡∏Å */
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
}

.neon-play-btn:hover {
  transform: scale(1.1);
  background: rgba(255, 255, 255, 0.25);
}

/* ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡πÅ‡∏™‡∏á‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á/‡∏ä‡∏°‡∏û‡∏π */
.neon-play-btn.playing {
  box-shadow: 
    0 0 20px #d946ef, 
    0 0 40px #8b5cf6, 
    inset 0 0 10px rgba(255, 255, 255, 0.5);
  border-color: #f0abfc;
}

.icon-play {
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 0 solid transparent;
  border-bottom: 15px solid transparent;
  border-top: 15px solid white;
}
</style>
</head>
<body>
  <div id="app-wrapper">
    <!-- Global Loader -->
    <div class="fixed inset-0 flex flex-col items-center justify-center z-[9999]" id="global-loader" style="background-color: #F7F5FF;">
      <div class="loader-lg"></div>
      <p class="mt-4 text-lg font-medium" id="loader-text" style="color: #2E2E2E;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö kissmodel...</p>
    </div>
    
    <!-- FIXED: ADDED BACK MISSING CONTAINERS -->
    <div id="toast-container" style="position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 10001;"></div>
    <div id="modal-root"></div>
    
    <!-- Login Container -->
    <div class="hidden min-h-screen flex items-center justify-center p-4" id="login-container">
      <div class="max-w-md w-full p-8 card-surface">
        <div class="text-center mb-8">
          <div class="kissmodel-logo inline-block mb-2">kissmodel<span class="star">üåü</span></div>
          <p class="mt-2 font-medium" style="color: var(--color-text-muted)">Administrator Access</p>
        </div>
        <form class="space-y-6" id="loginForm">
          <div><label class="text-sm font-medium" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input class="form-input mt-1" id="email" name="email" placeholder="admin@example.com" required type="email" value="adariscm2@gmail.com"/></div>
          <div><label class="text-sm font-medium" for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input class="form-input mt-1" id="password" name="password" placeholder="Password" required type="password" value=""/></div>
          <div><button class="w-full flex justify-center py-3 px-4 btn-pro" type="submit">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button></div>
          <p class="text-center text-sm font-medium" id="login-error" style="color: red;"></p>
        </form>
      </div>
    </div>
    
    <!-- Admin Content -->
    <div class="hidden" id="admin-content">
      <nav class="fixed top-0 left-0 h-full w-64 shadow-xl z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 card-surface" id="sidebar" style="border-radius: 0 1.25rem 1.25rem 0;">
        <div class="p-5 border-b flex items-center justify-center" style="border-color: var(--color-border);"><div class="kissmodel-logo">kissmodel<span class="star">üåü</span></div></div>
        <div class="p-4"><h2 class="text-xs font-semibold uppercase tracking-wider mb-3 px-2" style="color: var(--color-text-muted);">‡πÄ‡∏°‡∏ô‡∏π</h2>
          <ul class="space-y-1">
            <li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="dashboard-container"><i class="fas fa-chart-pie w-5 mr-3 text-center"></i>‡∏ö‡∏≠‡∏ó‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button></li>
            <li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="profiles-list-container"><i class="fas fa-users w-5 mr-3 text-center"></i>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button></li>
            <li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-action="add" data-view="profile-form-container"><i class="fas fa-user-plus w-5 mr-3 text-center"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</button></li>
            <li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="provinces-management-container"><i class="fas fa-map-marked-alt w-5 mr-3 text-center"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</button></li>
            <li><button class="nav-button w-full flex items-center text-left py-2.5 px-4 rounded-lg font-medium text-sm" data-view="ai-chat-container" style="color: rgb(var(--color-primary));"><i class="fas fa-robot w-5 mr-3 text-center"></i>‡∏ñ‡∏≤‡∏° AI Chatbot</button></li>
          </ul>
        </div>
        <div class="absolute bottom-0 w-full p-4 border-t" style="border-color: var(--color-border);"><div class="text-center mb-2" id="admin-user-info"></div><button class="w-full flex items-center justify-center gap-2 text-sm font-medium p-2 rounded-lg transition" id="logout-button" style="color: red; background-color: rgba(220, 53, 69, 0.1);"><i class="fas fa-sign-out-alt"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button></div>
      </nav>
      
      <header class="lg:pl-64" id="header"><div class="p-4 flex justify-between items-center"><button class="text-xl w-8 h-8 flex items-center justify-center" id="menu-toggle"><i class="fas fa-bars"></i></button><span class="font-bold" id="header-title" style="color: rgb(var(--color-primary));">kissmodel Admin</span></div></header>
      
      <main class="p-4 sm:p-6 lg:p-8 lg:ml-64">
        <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold dashboard-title" id="view-title">kissmodel<span class="star">üåü</span></h1><button class="flex items-center gap-2 px-4 py-2 rounded-lg shadow-sm text-sm font-medium transition card-surface" id="refresh-button"><i class="fas fa-sync-alt"></i><span class="hidden sm:inline">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span></button></div>
        <div id="view-content"><div class="container-pro section-gap"></div></div>
      </main>
    </div>
  </div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/+esm'

// Supabase Configuration
const supabaseUrl = 'https://tskkgyikkeiucndtneoe.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRza2tneWlra2VpdWNuZHRuZW9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzIyOTMsImV4cCI6MjA4NjEwODI5M30.-x6TN3XQS43QTKv4LpZv9AM4_Tm2q3R4Nd-KGo-KU1E';
const supabase = createClient(supabaseUrl, supabaseKey);
const STORAGE_BUCKET = 'profile-images';

// Application State
const AppState = {
  currentUser: null,
  provinces: [],
  allProfiles: [],
  filteredProfiles: [],
  stats: {},
  currentView: 'dashboard-container',
  isSidebarOpen: false,
  isInitialized: false,
  profileToEdit: null,
  currentParams: {},
  lastFetchTime: null
};

// DOM Elements
const DOM = {
  globalLoader: document.getElementById('global-loader'),
  loaderText: document.getElementById('loader-text'),
  loginContainer: document.getElementById('login-container'),
  loginForm: document.getElementById('loginForm'),
  loginError: document.getElementById('login-error'),
  adminContent: document.getElementById('admin-content'),
  sidebar: document.getElementById('sidebar'),
  adminUserInfo: document.getElementById('admin-user-info'),
  menuToggle: document.getElementById('menu-toggle'),
  headerTitle: document.getElementById('header-title'),
  viewTitle: document.getElementById('view-title'),
  viewContent: document.getElementById('view-content'),
  refreshButton: document.getElementById('refresh-button'),
  logoutButton: document.getElementById('logout-button'),
};

// UI Utilities
const UI = {
  debounce: (func, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  },
  
  showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const icon = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
    }[type];
    
    const bgColor = {
      success: 'bg-green-500',
      error: 'bg-red-600',
      info: 'bg-blue-500'
    }[type];
    
    toast.className = `flex items-center gap-3 p-4 rounded-lg text-white shadow-lg transform transition-all duration-300 translate-x-full ${bgColor}`;
    toast.innerHTML = `<i class="fas ${icon} text-xl"></i><span>${message}</span>`;
    container.appendChild(toast);
    
    requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
    
    setTimeout(() => {
      toast.classList.add('translate-x-full');
      toast.addEventListener('transitionend', () => toast.remove());
    }, duration);
  },
  
  showModal(config) {
    const {
      title,
      message,
      confirmText = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
      cancelText = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      onConfirm,
      isDestructive = true
    } = config;
    
    const modalRoot = document.getElementById('modal-root');
    const modalId = `modal-${Date.now()}`;
    const confirmBtnClass = isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-indigo-600 hover:bg-indigo-700';
    
    modalRoot.innerHTML = `
      <div id="${modalId}" class="fixed inset-0 z-[10002] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm modal-backdrop"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative modal-box">
          <h3 class="text-xl font-bold text-gray-900">${title}</h3>
          <div class="mt-2 text-sm text-gray-600">${message}</div>
          <div class="mt-6 flex justify-end space-x-3">
            <button class="modal-cancel-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
              ${cancelText}
            </button>
            <button class="modal-confirm-btn px-4 py-2 text-sm font-medium text-white ${confirmBtnClass} rounded-lg">
              ${confirmText}
            </button>
          </div>
        </div>
      </div>
    `;
    
    const modalEl = document.getElementById(modalId);
    const closeModal = () => modalEl.remove();
    
    modalEl.querySelector('.modal-confirm-btn').onclick = () => {
      onConfirm();
      closeModal();
    };
    
    modalEl.querySelector('.modal-cancel-btn').onclick = closeModal;
    modalEl.querySelector('.modal-backdrop').onclick = closeModal;
  },
  
  showProfileLightbox(profile) {
    const modalRoot = document.getElementById('modal-root');
    const placeholder = 'https://placehold.co/800x1000/f3f4f6/9ca3af?text=No+Image';
    const imageUrl = profile.imagePath
      ? supabase.storage.from(STORAGE_BUCKET).getPublicUrl(profile.imagePath).data.publicUrl
      : placeholder;
    
    const provinceName = AppState.provinces.find(p => p.key === profile.provinceKey)?.nameThai || 'N/A';
    const modalId = `lightbox-${profile.id}`;
    
    const detailItem = (icon, label, value) => {
      return value ? `
        <div class="flex items-start">
          <i class="fas fa-${icon} w-5 text-center text-indigo-500 mt-1"></i>
          <div class="ml-3">
            <p class="font-semibold text-slate-800">${label}</p>
            <p class="text-slate-600">${value}</p>
          </div>
        </div>
      ` : '';
    };
    
    const availabilityClass = {
      '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô': 'bg-green-100 text-green-800',
      '‡∏ß‡πà‡∏≤‡∏á': 'bg-green-100 text-green-800',
      '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß': 'bg-blue-100 text-blue-800',
      '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á': 'bg-red-100 text-red-800',
      '‡∏û‡∏±‡∏Å': 'bg-gray-100 text-gray-800'
    }[profile.availability] || 'bg-yellow-100 text-yellow-800';
    
    modalRoot.innerHTML = `
      <div id="${modalId}" class="fixed inset-0 z-[10002] flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm lightbox-backdrop"></div>
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative modal-box flex flex-col lg:flex-row">
          <button class="lightbox-close-btn absolute top-3 right-3 lg:top-4 lg:right-4 w-10 h-10 bg-black/30 hover:bg-black/50 text-white rounded-full z-10 flex items-center justify-center transition-colors">
            <i class="fas fa-times text-xl"></i>
          </button>
          <div class="w-full lg:w-5/12 flex-shrink-0">
            <img src="${imageUrl}" alt="${profile.altText || profile.name}" 
                 class="w-full h-full object-cover lg:rounded-l-2xl"
                 onerror="this.onerror=null;this.src='${placeholder}';">
          </div>
          <div class="p-6 lg:p-8 flex-grow overflow-y-auto">
            ${profile.isfeatured ? '<span class="inline-block bg-amber-400 text-black text-xs font-bold px-3 py-1 rounded-full mb-3"><i class="fas fa-star"></i> ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''}
            <h3 class="text-3xl font-bold text-slate-900">${profile.name || 'N/A'}</h3>
            <p class="text-lg text-indigo-600 font-medium">${profile.quote || ''}</p>
            <div class="my-6 border-t border-slate-200"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5 text-sm">
              ${detailItem('map-marker-alt', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏û‡∏¥‡∏Å‡∏±‡∏î', `${provinceName}${profile.location ? ` (${profile.location})` : ''}`)}
              ${detailItem('money-bill-wave', '‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤', profile.rate)}
              ${detailItem('phone-alt', 'LINE ID', profile.lineId)}
              <div class="flex items-start">
                <i class="fas fa-clock w-5 text-center text-indigo-500 mt-1"></i>
                <div class="ml-3">
                  <p class="font-semibold text-slate-800">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
                  <span class="px-2 py-1 text-xs font-medium rounded-full ${availabilityClass}">
                    ${profile.availability || '‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°'}
                  </span>
                </div>
              </div>
              ${detailItem('ruler-combined', '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô', profile.stats)}
              ${detailItem('arrows-alt-v', '‡∏™‡∏π‡∏á / ‡∏´‡∏ô‡∏±‡∏Å', [profile.height, profile.weight].filter(Boolean).join(' / '))}
              ${detailItem('palette', '‡∏™‡∏µ‡∏ú‡∏¥‡∏ß', profile.skinTone)}
              ${detailItem('birthday-cake', '‡∏≠‡∏≤‡∏¢‡∏∏', profile.age)}
            </div>
            ${profile.description ? `
              <div class="mt-6 pt-6 border-t border-slate-200">
                <h4 class="font-semibold text-slate-800 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                <p class="text-slate-600 whitespace-pre-wrap">${profile.description}</p>
              </div>
            ` : ''}
            ${profile.styleTags && profile.styleTags.length > 0 ? `
              <div class="mt-6 pt-6 border-t border-slate-200">
                <h4 class="font-semibold text-slate-800 mb-2">‡∏™‡πÑ‡∏ï‡∏•‡πå</h4>
                <div class="flex flex-wrap gap-2">
                  ${profile.styleTags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
    
    const modalEl = document.getElementById(modalId);
    const closeModal = () => modalEl.remove();
    
    modalEl.querySelector('.lightbox-close-btn').onclick = closeModal;
    modalEl.querySelector('.lightbox-backdrop').onclick = closeModal;
  },
  
  toggleButtonLoading(button, isLoading, defaultText = 'Submit') {
    if (!button) return;
    button.disabled = isLoading;
    button.innerHTML = isLoading
      ? `<span class="loader-sm w-5 h-5 inline-block"></span>`
      : defaultText;
  },
  
  setActiveNav(viewId) {
    document.querySelectorAll('.nav-button').forEach(b => {
      const isActive = b.dataset.view === viewId;
      b.classList.toggle('bg-indigo-100', isActive);
      b.classList.toggle('text-indigo-700', isActive);
      b.classList.toggle('text-slate-600', !isActive);
    });
  },
};

// Main Application Controller
const Controller = {
  async initApp() {
    DOM.globalLoader.classList.remove('hidden');
    DOM.loaderText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô...";
    
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error("Error fetching session:", error);
      this.showLoginScreen("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
      return;
    }
    
    if (session) {
      AppState.currentUser = session.user;
      await this.startAdminPanel();
    } else {
      this.showLoginScreen();
    }
    
    // Listen for auth state changes
    supabase.auth.onAuthStateChange((_event, session) => {
      if (session && !AppState.currentUser) {
        AppState.currentUser = session.user;
        this.startAdminPanel();
      } else if (!session && AppState.currentUser) {
        AppState.currentUser = null;
        this.showLoginScreen("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    });
  },
  
  showLoginScreen(toastMessage = null) {
    AppState.isInitialized = false;
    AppState.currentUser = null;
    DOM.adminContent.classList.add('hidden');
    DOM.loginContainer.classList.remove('hidden');
    DOM.globalLoader.classList.add('hidden');
    
    if (toastMessage) {
      UI.showToast(toastMessage, 'info');
    }
  },
  
  async startAdminPanel() {
    if (AppState.isInitialized) return;
    
    AppState.isInitialized = true;
    DOM.loaderText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
    DOM.loginContainer.classList.add('hidden');
    DOM.adminContent.classList.remove('hidden');
    DOM.globalLoader.classList.remove('hidden');
    
    DOM.adminUserInfo.innerHTML = `<p class="text-sm font-semibold text-slate-800">${AppState.currentUser.email.split('@')[0]}</p>`;
    
    try {
      await this.fetchData();
      this.renderView('dashboard-container');
      UI.showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!', 'success');
    } catch (err) {
      DOM.viewContent.innerHTML = `
        <div class="text-center p-8 bg-white rounded-lg shadow">
          <h2 class="text-xl font-bold text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h2>
          <p class="mt-2 text-red-500">${err.message}</p>
        </div>
      `;
      UI.showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'error');
    } finally {
      DOM.globalLoader.classList.add('hidden');
    }
  },
  
  async handleLogin(e) {
    e.preventDefault();
    const form = e.target;
    const loginButton = form.querySelector('button[type="submit"]');
    
    UI.toggleButtonLoading(loginButton, true, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    DOM.loginError.textContent = '';
    
    const { error } = await supabase.auth.signInWithPassword({
      email: form.email.value,
      password: form.password.value,
    });
    
    if (error) {
      DOM.loginError.textContent = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
      UI.showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
      UI.toggleButtonLoading(loginButton, false, '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    }
  },
  
  async handleLogout() {
    UI.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...', 'info');
    await supabase.auth.signOut();
  },
  
  setupEventListeners() {
    if (this.listenersInitialized) return;
    
    DOM.loginForm.addEventListener('submit', e => this.handleLogin(e));
    DOM.logoutButton.addEventListener('click', () => this.handleLogout());
    DOM.menuToggle.addEventListener('click', () => {
      DOM.sidebar.classList.toggle('-translate-x-full');
    });
    
    DOM.refreshButton.addEventListener('click', async () => {
      UI.showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'info');
      await this.loadInitialData();
    });
    
    document.body.addEventListener('click', e => {
      const navButton = e.target.closest('.nav-button');
      if (navButton) {
        this.renderView(navButton.dataset.view, { action: navButton.dataset.action });
      }
      
      const editBtn = e.target.closest('.edit-profile-btn');
      if (editBtn) {
        this.renderView('profile-form-container', { profileId: editBtn.dataset.id });
      }
      
      const deleteBtn = e.target.closest('.delete-profile-btn');
      if (deleteBtn) {
        this.handleDeleteProfile(deleteBtn.dataset);
      }
      
      const previewBtn = e.target.closest('#preview-profile-button');
      if (previewBtn) {
        this.handlePreviewProfile();
      }
      
      const profileCard = e.target.closest('.profile-card-clickable');
      if (profileCard && !e.target.closest('button')) {
        const profile = AppState.allProfiles.find(p => p.id == profileCard.dataset.id);
        if (profile) {
          UI.showProfileLightbox(profile);
        }
      }
      
      const deleteProvinceBtn = e.target.closest('.delete-province-btn');
      if (deleteProvinceBtn) {
        this.handleDeleteProvince(deleteProvinceBtn.dataset);
      }
    });
    
    this.listenersInitialized = true;
  },
  
  async loadInitialData() {
    await this.fetchData();
    const currentView = AppState.currentView;
    const currentParams = AppState.currentParams;
    this.renderView(currentView, currentParams);
  },
  
  async fetchData(force = false) {
    const lastFetchTime = AppState.lastFetchTime || '1970-01-01T00:00:00Z';
    
    // Fetch profiles updated since last fetch
    const profilesResponse = await supabase
      .from('profiles')
      .select('*')
      .gte('lastUpdated', lastFetchTime);
    
    if (profilesResponse.error) throw profilesResponse.error;
    
    const newProfiles = profilesResponse.data || [];
    
    // Update AppState.allProfiles
    newProfiles.forEach(p => {
      const index = AppState.allProfiles.findIndex(existing => existing.id === p.id);
      if (index !== -1) {
        AppState.allProfiles[index] = p;
      } else {
        AppState.allProfiles.push(p);
      }
    });
    
    // Update lastFetchTime
    AppState.lastFetchTime = new Date().toISOString();
    
    // Fetch provinces if needed
    if (force || !Array.isArray(AppState.provinces) || AppState.provinces.length === 0) {
      const provincesResponse = await supabase
        .from('provinces')
        .select('*')
        .order('nameThai');
      
      if (provincesResponse.error) throw provincesResponse.error;
      AppState.provinces = provincesResponse.data || [];
    }
    
    // Update stats
    this.updateStats();
  },
  
  updateStats() {
    AppState.stats.profiles = AppState.allProfiles.length;
    AppState.stats.featured = AppState.allProfiles.filter(p => p.isfeatured).length;
    AppState.stats.provinces = AppState.provinces.length;
  },
  
  renderView(viewId, params = {}) {
    AppState.currentView = viewId;
    AppState.currentParams = params;
    
    DOM.viewContent.innerHTML = `
      <div class="flex justify-center p-16">
        <div class="loader-lg"></div>
      </div>
    `;
    
    UI.setActiveNav(viewId);
    
    const activeNav = document.querySelector(`.nav-button[data-view="${viewId}"]`);
    if (activeNav) {
      const titleText = activeNav.textContent.trim();
      DOM.headerTitle.textContent = titleText;
      DOM.viewTitle.textContent = titleText;
    }
    
    if (window.innerWidth < 1024) {
      DOM.sidebar.classList.add('-translate-x-full');
    }
    
    const renderFunction = this[`render${viewId.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('')}`];
    
    if (typeof renderFunction === 'function') {
      renderFunction.call(this, params);
    } else {
      DOM.viewContent.innerHTML = `<p>View not implemented: ${viewId}</p>`;
    }
  },

  calculateDashboardStats() {
    const profiles = AppState.allProfiles;
    const stats = {
        uploadsLast7Days: { labels: [], values: Array(7).fill(0) },
        profilesByProvince: {},
    };
    const today = new Date();
    today.setHours(23, 59, 59, 999);

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    for (let i = 0; i < 7; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        stats.uploadsLast7Days.labels.push(d.toLocaleDateString('th-TH', { weekday: 'short' }));

        const startOfDay = new Date(d);
        startOfDay.setHours(0, 0, 0, 0);

        profiles.forEach(p => {
            if (p.lastUpdated) {
                const updatedDate = new Date(p.lastUpdated);
                if (updatedDate >= startOfDay && updatedDate <= d) {
                    stats.uploadsLast7Days.values[i]++;
                }
            }
        });
    }
    stats.uploadsLast7Days.labels.reverse();
    stats.uploadsLast7Days.values.reverse();

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    AppState.provinces.forEach(prov => {
        const count = profiles.filter(p => p.provinceKey === prov.key).length;
        if (count > 0) {
            stats.profilesByProvince[prov.nameThai] = count;
        }
    });

    return stats;
  },

// ================== ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ "‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà" ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ==================

  renderDashboardContainer() {
    const { profiles, featured, provinces } = AppState.stats;
    const dashboardStats = this.calculateDashboardStats();

    const statsCards = [
        { i: 'users', c: 'indigo', t: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', v: profiles || 0 },
        { i: 'star', c: 'amber', t: '‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', v: featured || 0 },
        { i: 'map-marked-alt', c: 'emerald', t: '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', v: provinces || 0 }
    ];

    DOM.viewContent.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${statsCards.map(s => `
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center gap-5">
                <i class="fas fa-${s.i} text-3xl text-${s.c}-500 bg-${s.c}-100 p-4 rounded-full"></i>
                <div>
                <p class="text-sm text-slate-500">${s.t}</p>
                <p class="text-3xl font-bold text-slate-800">${s.v}</p>
                </div>
            </div>
            `).join('')}
        </div>
        
        <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h4 class="text-lg font-semibold text-slate-800 mb-3">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
                <canvas id="chart-uploads"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h4 class="text-lg font-semibold text-slate-800 mb-3">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</h4>
                <canvas id="chart-provinces"></canvas>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        const chartUploadsCtx = document.getElementById('chart-uploads')?.getContext('2d');
        if(chartUploadsCtx) {
            new Chart(chartUploadsCtx, {
                type: 'bar',
                data: {
                    labels: dashboardStats.uploadsLast7Days.labels,
                    datasets: [{
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
                        data: dashboardStats.uploadsLast7Days.values,
                        backgroundColor: 'rgba(129, 140, 248, 0.6)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        const chartProvincesCtx = document.getElementById('chart-provinces')?.getContext('2d');
        if(chartProvincesCtx) {
            new Chart(chartProvincesCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dashboardStats.profilesByProvince),
                    datasets: [{
                        data: Object.values(dashboardStats.profilesByProvince),
                        backgroundColor: ['#ec4899', '#a855f7', '#38bdf8', '#34d399', '#f59e0b', '#94a3b8'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });
        }
    }, 100);
  },
  
  renderProfilesListContainer() {
    DOM.viewContent.innerHTML = `
      <div class="space-y-6">
        <div class="bg-white p-4 rounded-xl shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="md:col-span-2">
              <label for="search-input" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</label>
              <input type="text" id="search-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏û‡∏¥‡∏Å‡∏±‡∏î, LINE, ‡∏™‡πÑ‡∏ï‡∏•‡πå..." class="form-input">
            </div>
            <div>
              <label for="filter-province" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
              <select id="filter-province" class="form-input">
                <option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
                ${AppState.provinces.map(p => `<option value="${p.key}">${p.nameThai}</option>`).join('')}
              </select>
            </div>
            <div class="flex items-center justify-start md:justify-end pb-2">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="filter-featured" class="h-4 w-4 text-indigo-600 rounded">
                  <span class="font-medium text-slate-700">‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                </label>
            </div>
          </div>
        </div>
        <div id="profiles-grouped-list" class="space-y-8"></div>
      </div>
    `;

    document.getElementById('search-input').addEventListener('input', UI.debounce(() => this.renderGroupedProfileCards(), 300));
    document.getElementById('filter-province').addEventListener('change', () => this.renderGroupedProfileCards());
    document.getElementById('filter-featured').addEventListener('change', () => this.renderGroupedProfileCards());
    
    this.renderGroupedProfileCards();
  },
  
  renderGroupedProfileCards() {
    const listEl = document.getElementById('profiles-grouped-list');
    if (!listEl) return;

    const searchTerm = document.getElementById('search-input')?.value.toLowerCase().trim() || '';
    const selectedProvince = document.getElementById('filter-province')?.value || '';
    const isFeaturedOnly = document.getElementById('filter-featured')?.checked || false;

    let filteredProfiles = AppState.allProfiles;

    if (searchTerm) {
      filteredProfiles = filteredProfiles.filter(p => {
        const tagsString = (p.styleTags || []).join(' ').toLowerCase();
        return (p.name && p.name.toLowerCase().includes(searchTerm)) ||
               (p.location && p.location.toLowerCase().includes(searchTerm)) ||
               (p.lineId && p.lineId.toLowerCase().includes(searchTerm)) ||
               (tagsString.includes(searchTerm));
      });
    }

    if (selectedProvince) {
      filteredProfiles = filteredProfiles.filter(p => p.provinceKey === selectedProvince);
    }

    if (isFeaturedOnly) {
      filteredProfiles = filteredProfiles.filter(p => p.isfeatured);
    }
    
    let html = AppState.provinces.map(province => {
      const profilesInProvince = filteredProfiles.filter(p => p.provinceKey === province.key);
      if (profilesInProvince.length === 0) return '';
      
      return `
        <div class="province-group">
          <h2 class="text-2xl font-bold text-slate-800 border-b-2 border-indigo-200 pb-2 mb-4">
            ${province.nameThai}
          </h2>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            ${profilesInProvince.map(p => this.getProfileCardHTML(p)).join('')}
          </div>
        </div>
      `;
    }).join('');
    
    listEl.innerHTML = html || `
      <p class="col-span-full text-center py-16 text-slate-500">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </p>
    `;
  },

getProfileCardHTML(p) {
    // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡∏°‡πà)
    let imgUrl = 'https://placehold.co/400x500?text=No+Image';
    if (p.imagePaths && p.imagePaths.length > 0) {
        imgUrl = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(p.imagePaths[0]).data.publicUrl;
    } else if (p.imagePath) {
        imgUrl = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(p.imagePath).data.publicUrl;
    }

    // 2. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
    const provName = AppState.provinces.find(prov => prov.key === p.provinceKey)?.nameThai || p.provinceKey || '-';

    // 3. ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô HTML (‡πÄ‡∏û‡∏¥‡πà‡∏° class 'profile-card-clickable' ‡πÅ‡∏•‡∏∞ 'data-id' ‡πÅ‡∏•‡πâ‡∏ß)
    return `
      <div class="card-surface overflow-hidden group relative flex flex-col h-full profile-card-clickable cursor-pointer" data-id="${p.id}">
        <div class="relative aspect-[3/4]">
            <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy">
            ${p.isfeatured ? '<span class="absolute top-2 right-2 bg-yellow-400 text-black text-xs px-2 py-1 rounded font-bold">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : ''}
        </div>
        <div class="p-3 flex flex-col flex-grow">
          <h4 class="font-bold text-lg truncate" style="color: var(--color-text-main)">${p.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
          <p class="text-sm opacity-70 mb-2" style="color: var(--color-text-muted)">${provName}</p>
          
          <div class="mt-auto flex gap-2 pt-2 border-t border-gray-200">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
            <button class="edit-profile-btn flex-1 py-1.5 bg-pink-500 text-white text-sm rounded shadow hover:bg-pink-600 transition" data-id="${p.id}">
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö -->
            <button class="delete-profile-btn px-3 py-1.5 bg-gray-200 text-gray-600 text-sm rounded hover:bg-red-500 hover:text-white transition" 
                    data-id="${p.id}" 
                    data-name="${p.name}" 
                    data-imagePath="${(p.imagePaths && p.imagePaths[0]) || p.imagePath || ''}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  },
// ================ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà renderProfileFormContainer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ ================
  async renderProfileFormContainer(params = {}) {
    const profileId = params.profileId;
    const isEditing = !!profileId;
    let p = {};
    
    if (isEditing) {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', profileId)
        .single();
      
      if (error) {
        UI.showToast("‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠", "error");
        return this.renderView('profiles-list-container');
      }
      p = data;
    }
    
    const imageUrl = (p.imagePaths && p.imagePaths[0]) || p.imagePath
      ? supabase.storage.from(STORAGE_BUCKET).getPublicUrl((p.imagePaths && p.imagePaths[0]) || p.imagePath).data.publicUrl
      : null;
    
    const formHTML = `
      <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
        <form id="profile-form" class="space-y-8">
          <input type="hidden" id="profile-id" value="${p.id || ''}">
          <input type="hidden" id="current-image-path" value="${(p.imagePaths && p.imagePaths[0]) || p.imagePath || ''}">
          
          <div>
            <h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
            <div class="flex flex-col md:flex-row gap-6 items-start">
              <div id="image-uploader" class="flex-shrink-0"></div>
              <div class="flex-grow space-y-4">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="checkbox" id="isFeatured" class="h-5 w-5 text-indigo-600 rounded" ${p.isfeatured ? 'checked' : ''}>
                  <span class="font-medium text-gray-700">‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>
                </label>
                <div>
                  <label for="availability" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</label>
                  <select id="availability" class="form-input">
                    ${['‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏¥‡∏ß', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô', '‡∏ß‡πà‡∏≤‡∏á', '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô', '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á', '‡∏û‡∏±‡∏Å'].map(s => `
                      <option value="${s}" ${p.availability === s ? 'selected' : ''}>${s}</option>
                    `).join('')}
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <div>
            <h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div><label for="name" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠*</label><input type="text" id="name" required class="form-input" value="${p.name || ''}"></div>
              <div><label for="age" class="block text-sm font-medium text-slate-700 mb-1">‡∏≠‡∏≤‡∏¢‡∏∏</label><input type="number" id="age" class="form-input" value="${p.age || ''}"></div>
              <div><label for="stats" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</label><input type="text" id="stats" class="form-input" value="${p.stats || ''}" placeholder="36-24-35"></div>
              <div><label for="height" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏π‡∏á (cm)</label><input type="text" id="height" class="form-input" value="${p.height || ''}"></div>
              <div><label for="weight" class="block text-sm font-medium text-slate-700 mb-1">‡∏´‡∏ô‡∏±‡∏Å (kg)</label><input type="text" id="weight" class="form-input" value="${p.weight || ''}"></div>
              <div><label for="skinTone" class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡∏µ‡∏ú‡∏¥‡∏ß</label><input type="text" id="skinTone" class="form-input" value="${p.skinTone || ''}" placeholder="‡∏Ç‡∏≤‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á"></div>
            </div>
          </div>
          
          <div>
            <h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div><label for="provinceKey" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠*</label><select id="provinceKey" required class="form-input">${AppState.provinces.map(prov => `<option value="${prov.key}" ${p.provinceKey === prov.key ? 'selected' : ''}>${prov.nameThai}</option>`).join('')}</select></div>
              <div><label for="location" class="block text-sm font-medium text-slate-700 mb-1">‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏¢‡πà‡∏≠‡∏¢)</label><input type="text" id="location" class="form-input" value="${p.location || ''}" placeholder="‡∏ô‡∏¥‡∏°‡∏°‡∏≤‡∏ô, ‡∏™‡∏±‡∏ô‡∏ï‡∏¥‡∏ò‡∏£‡∏£‡∏°"></div>
              <div><label for="rate" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏£‡∏ó‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="text" id="rate" class="form-input" value="${p.rate || ''}" placeholder="1500/1"></div>
              <div><label for="lineId" class="block text-sm font-medium text-slate-700 mb-1">LINE ID</label><input type="text" id="lineId" class="form-input" value="${p.lineId || ''}"></div>
            </div>
          </div>
          
          <div>
            <h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞ Keyword</h3>
            <div class="space-y-4">
              <div><label for="quote" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ</label><input type="text" id="quote" class="form-input" value="${p.quote || ''}"></div>
              <div><label for="description" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="description" rows="6" class="form-input">${p.description || ''}</textarea></div>
              <div><label class="block text-sm font-medium text-slate-700 mb-1">‡∏™‡πÑ‡∏ï‡∏•‡πå (Tags)</label><div id="tag-input-component"></div></div>
              <div><label for="altText" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Alt Text)</label><input type="text" id="altText" class="form-input" value="${p.altText || ''}" placeholder="‡∏ô‡πâ‡∏≠‡∏á..? ‡πÑ‡∏ã‡∏î‡πå‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô.‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î? ‡∏ü‡∏¥‡∏ß‡πÅ‡∏ü‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏°‡∏±‡∏î‡∏à‡∏≥"></div>
            </div>
          </div>

          <div>
            <h3 class="text-xl font-semibold text-indigo-700 mb-4 border-b pb-2">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SEO (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google)</h3>
            <div class="space-y-4">
              <div><label for="seo-title" class="block text-sm font-medium text-slate-700 mb-1">SEO Title</label><input type="text" id="seo-title" class="form-input" value="${p.seo_title || ''}"></div>
              <div><label for="meta-description" class="block text-sm font-medium text-slate-700 mb-1">Meta Description</label><textarea id="meta-description" rows="3" class="form-input">${p.meta_description || ''}</textarea></div>
              <div><label for="slug" class="block text-sm font-medium text-slate-700 mb-1">‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô </label><input type="text" id="slug" class="form-input" value="${p.slug || ''}" placeholder="nong-yaimai-chiangmai"></div>
            </div>
          </div>
          
          <div class="pt-5 flex justify-between items-center border-t">
            <button type="button" class="nav-button px-6 py-2.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200" data-view="profiles-list-container">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <div class="flex items-center space-x-3">
              <button type="button" id="preview-profile-button" class="px-4 py-2.5 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200"><i class="fas fa-eye mr-2"></i>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
              <button type="submit" id="save-profile-button" class="flex items-center justify-center px-6 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 btn-pro">${isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á'}</button>
            </div>
          </div>
        </form>
      </div>
    `;

    DOM.viewContent.innerHTML = formHTML;
    this.initImageUploader(imageUrl);
    this.initTagInput(p.styleTags || []);
    document.getElementById('profile-form').addEventListener('submit', e => this.handleProfileFormSubmit(e));
  },

// =========================================================================
// =========================================================================
// =========================================================================

  initImageUploader(imageUrl) {
    const uploaderEl = document.getElementById('image-uploader');
    uploaderEl.innerHTML = `
      <div class="space-y-3">
        <div id="dz" class="relative w-full min-h-[12rem] rounded-xl p-6 border-2 border-dashed border-slate-300 bg-slate-50
                           hover:border-indigo-400 transition cursor-pointer">
          <input type="file" id="image-file-input" accept="image/*" multiple
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          <div class="pointer-events-none text-center">
            <p class="text-sm text-slate-600 font-medium">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ</p>
            <p class="text-xs text-slate-500 mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÄ‡∏õ‡πá‡∏ô .webp ‡∏Ç‡∏ô‡∏≤‡∏î 1200px / ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 85%</p>
          </div>
        </div>
        <div id="multi-preview" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      </div>
    `;
    
    const fileInput = document.getElementById('image-file-input');
    const dz = document.getElementById('dz');
    const previewGrid = document.getElementById('multi-preview');
    
    const renderPreview = (files) => {
      previewGrid.innerHTML = '';
      files.forEach(f => {
        const url = URL.createObjectURL(f);
        const card = document.createElement('div');
        card.className = 'relative rounded-xl overflow-hidden shadow bg-white';
        card.innerHTML = `
          <img src="${url}" class="w-full h-40 object-cover" alt="">
          <div class="absolute bottom-0 inset-x-0 bg-black/40 text-white text-xs p-1 truncate">${f.name}</div>
        `;
        previewGrid.appendChild(card);
      });
    };
    
    dz.addEventListener('click', () => fileInput.click());
    dz.addEventListener('dragover', e => {
      e.preventDefault();
      dz.classList.add('border-indigo-400');
    });
    
    dz.addEventListener('dragleave', () => {
      dz.classList.remove('border-indigo-400');
    });
    
    dz.addEventListener('drop', e => {
      e.preventDefault();
      dz.classList.remove('border-indigo-400');
      const dtFiles = Array.from(e.dataTransfer.files || []).filter(f => /^image\//.test(f.type));
      if (!dtFiles.length) return;
      
      const dataTransfer = new DataTransfer();
      dtFiles.forEach(f => dataTransfer.items.add(f));
      fileInput.files = dataTransfer.files;
      renderPreview(dtFiles);
    });
    
    fileInput.addEventListener('change', e => {
      renderPreview(Array.from(e.target.files || []));
    });
    
    if (imageUrl) {
      previewGrid.innerHTML = `
        <div class="relative rounded-xl overflow-hidden shadow bg-white">
          <img src="${imageUrl}" class="w-full h-40 object-cover" alt="">
          <div class="absolute bottom-0 inset-x-0 bg-black/40 text-white text-xs p-1 truncate">‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div>
        </div>
      `;
    }
  },
  
// ============================================================================
// ‚úÖ FIXED: initTagInput - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö Tag ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
// ============================================================================
initTagInput(initialTags = []) {
  const container = document.getElementById('tag-input-component');
  let tags = [...initialTags].map(t => (typeof t === 'string' ? t.trim() : t)).filter(Boolean);
  
  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Tag ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  const suggestedTags = ['‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å', '‡πÄ‡∏≠‡∏≤‡πÉ‡∏à‡πÄ‡∏Å‡πà‡∏á', '‡∏™‡∏≤‡∏¢‡∏ù‡∏≠', '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å', '‡∏ú‡∏¥‡∏ß‡∏Ç‡∏≤‡∏ß', '‡∏≠‡∏ß‡∏ö', '‡∏Ñ‡∏∏‡∏¢‡∏™‡∏ô‡∏∏‡∏Å', '‡∏ü‡∏¥‡∏•‡πÅ‡∏ü‡∏ô', '‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏£‡∏µ‡∏ö'];

  const render = () => {
    container.innerHTML = `
      <div class="tag-input-container bg-white">
        ${tags.map(tag => `
          <div class="tag-item">
            <span>${tag.trim()}</span>
            <i class="fas fa-times tag-remove-btn" data-tag="${tag}"></i>
          </div>
        `).join('')}
        <input type="text" class="tag-input" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter...">
      </div>
      <p class="text-xs text-slate-500 mt-1">
        Tag ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡πÄ‡∏à‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠ SEO
      </p>
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏° Tag ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
      <div class="mt-2 flex flex-wrap gap-2">
        ${suggestedTags.map(tag => 
          !tags.includes(tag) ? `<button type="button" class="suggest-tag-btn text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full hover:bg-indigo-200">${tag}</button>` : ''
        ).join('')}
      </div>
    `;
    
    // ‚úÖ Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å Tag ‡∏à‡∏≤‡∏Å‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå
    const inputEl = container.querySelector('.tag-input');
    if (inputEl) {
      inputEl.addEventListener('keydown', e => {
        if (e.key === 'Enter' && e.target.value.trim()) {
          e.preventDefault();
          
          // ‚úÖ ‡πÅ‡∏Å‡πâ: Split by comma ‡πÅ‡∏•‡∏∞ trim ‡πÅ‡∏ï‡πà‡∏•‡∏∞ tag
          const newTags = e.target.value.trim()
            .split(',')
            .map(t => t.trim())
            .filter(Boolean);  // ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
          
          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° tags ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á‡πÑ‡∏õ
          tags.push(...newTags);
          
          // ‚úÖ ‡∏•‡∏ö duplicate tags
          tags = [...new Set(tags)];
          
          // ‚úÖ Render ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô focus
          render();
          e.target.value = '';
          inputEl.focus();
        }
      });
    }
    
    // ‚úÖ Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö Tag
    container.querySelectorAll('.tag-remove-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const tagToRemove = e.target.dataset.tag;
        tags = tags.filter(t => t !== tagToRemove);
        render();
      });
    });

    // ‚úÖ Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Tag ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    container.querySelectorAll('.suggest-tag-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const tagText = btn.textContent.trim();
        
        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° tag ‡∏ã‡πâ‡∏≥
        if (!tags.includes(tagText)) {
          tags.push(tagText);
          tags = [...new Set(tags)];  // ‚úÖ ‡∏•‡∏ö duplicate
          render();
        }
      });
    });
  };
  
  render();
},

// ============================================================================
// ‚úÖ FIXED: collectFormData - ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á imagePath ‡πÅ‡∏•‡∏∞ imagePaths
// ============================================================================
collectFormData(form) {
  // ‚úÖ ‡∏î‡∏∂‡∏á styleTags ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  const styleTags = Array.from(form.querySelectorAll('.tag-item span'))
    .map(span => span.textContent.trim())
    .filter(Boolean);  // ‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á
  
  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á slug ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å
  const name = form.querySelector('#name').value.trim();
  const slugInput = form.querySelector('#slug').value.trim();
  let finalSlug = '';
  
  if (slugInput) {
    // ‚úÖ ‡πÉ‡∏ä‡πâ slug ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å
    finalSlug = slugInput
      .toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');  // ‚úÖ ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©
  } else if (name) {
    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ slug ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
    finalSlug = name
      .toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/[^a-z0-9-]/g, '');
  }
  
  return {
    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
    name: name,
    age: parseInt(form.querySelector('#age').value) || null,
    height: form.querySelector('#height').value.trim(),
    weight: form.querySelector('#weight').value.trim(),
    stats: form.querySelector('#stats').value.trim(),
    skinTone: form.querySelector('#skinTone').value.trim(),
    
    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠
    provinceKey: form.querySelector('#provinceKey').value,
    location: form.querySelector('#location').value.trim(),
    rate: form.querySelector('#rate').value.trim(),
    availability: form.querySelector('#availability').value,
    lineId: form.querySelector('#lineId').value.trim(),
    
    // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    quote: form.querySelector('#quote').value.trim(),
    description: form.querySelector('#description').value.trim(),
    altText: form.querySelector('#altText').value.trim() || name,
    isfeatured: form.querySelector('#isFeatured').checked,
    styleTags: styleTags,
    
    // ‚úÖ SEO
    seo_title: form.querySelector('#seo-title').value.trim(),
    meta_description: form.querySelector('#meta-description').value.trim(),
    slug: finalSlug,
    
    // ‚úÖ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
    imagePath: null,
    imagePaths: [],
    
    // ‚úÖ Timestamp (‡πÉ‡∏´‡πâ Supabase auto-set ‡πÄ‡∏≠‡∏á)
    // ‡∏•‡∏ö lastUpdated ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Supabase ‡∏°‡∏µ updated_at ‡∏ó‡∏µ‡πà auto-update
  };
},

// ============================================================================
// ‚úÖ FIXED: handleProfileFormSubmit - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å imagePath ‡πÅ‡∏•‡∏∞ imagePaths
// ============================================================================
async handleProfileFormSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const profileId = form.querySelector('#profile-id').value;
  const isEditing = !!profileId;
  const saveButton = form.querySelector('#save-profile-button');
  
  UI.toggleButtonLoading(saveButton, true, isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á');
  
  try {
    const fileInput = form.querySelector('#image-file-input');
    let imagePath = form.querySelector('#current-image-path').value || '';
    let uploadedPaths = [];
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
    const files = (fileInput && fileInput.files) ? Array.from(fileInput.files) : [];
    
    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    if (!isEditing && files.length === 0 && !imagePath) {
      throw new Error('‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏π‡∏õ');
    }
    
    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
    if (files.length) {
      UI.showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${files.length} ‡πÑ‡∏ü‡∏•‡πå...`, 'info');
      
      const toWebp1200 = async (file) => {
        const bitmap = await createImageBitmap(file);
        const scale = bitmap.width > 1200 ? 1200 / bitmap.width : 1;
        const w = Math.round(bitmap.width * scale);
        const h = Math.round(bitmap.height * scale);
        
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.filter = 'contrast(1.06) saturate(1.06) brightness(1.02)';
        ctx.drawImage(bitmap, 0, 0, w, h);
        
        const blob = await new Promise(res => canvas.toBlob(res, 'image/webp', 0.85));
        return new File([blob], (file.name.replace(/\.[^.]+$/, '') || 'img') + '.webp', { type: 'image/webp' });
      };
      
      for (const f of files) {
        const webpFile = await toWebp1200(f);
        const fileName = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}.webp`;
        const { data, error } = await supabase.storage
          .from(STORAGE_BUCKET)
          .upload(fileName, webpFile, { upsert: true });
        
        if (error) throw new Error(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
        uploadedPaths.push(data.path);
      }
      
      // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ imagePath ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      imagePath = uploadedPaths[0];
    }
    
    const profileData = this.collectFormData(form);
    
    // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î imagePath ‡πÅ‡∏•‡∏∞ imagePaths ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (uploadedPaths.length > 0) {
      // ‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      profileData.imagePaths = uploadedPaths;
      profileData.imagePath = uploadedPaths[0]; // ‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å
    } else if (imagePath && imagePath.trim() !== '' && imagePath !== 'null') {
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤ (‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå)
      profileData.imagePath = imagePath;
      // imagePaths ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ [] ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    }
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡πÅ‡∏ö‡∏ö ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ imagePath: null ‡πÅ‡∏•‡∏∞ imagePaths: [] ‡∏à‡∏≤‡∏Å collectFormData
    
    let dbRes;
    if (isEditing) {
      dbRes = await supabase
        .from('profiles')
        .update(profileData)
        .eq('id', profileId)
        .select()
        .single();
    } else {
      dbRes = await supabase
        .from('profiles')
        .insert(profileData)
        .select()
        .single();
    }
    
    if (dbRes.error) throw new Error(dbRes.error.message);
    
    UI.showToast(isEditing ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    this.renderView('profiles-list-container');
  } catch (err) {
    console.error(err);
    UI.showToast(err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
  } finally {
    UI.toggleButtonLoading(saveButton, false, isEditing ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡∏™‡∏£‡πâ‡∏≤‡∏á');
  }
},

// ============================================================================
// ‚úÖ FIXED: handlePreviewProfile - ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
// ============================================================================
handlePreviewProfile() {
  const form = document.getElementById('profile-form');
  if (!form) return;
  
  const profileData = this.collectFormData(form);
  const currentImagePath = form.querySelector('#current-image-path').value;
  const fileInput = form.querySelector('#image-file-input');
  const imageFile = (fileInput && fileInput.files && fileInput.files.length > 0) 
    ? fileInput.files[0] 
    : null;
  
  // ‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
  if (imageFile) {
    profileData.imagePath = URL.createObjectURL(imageFile);
  } else if (currentImagePath && currentImagePath.trim() !== '') {
    profileData.imagePath = currentImagePath;
  } else {
    profileData.imagePath = 'https://placehold.co/400x500?text=No+Image';
  }
  
  UI.showProfileLightbox(profileData);
},

// ============================================================================
// ‚úÖ FIXED: handleDeleteProfile - ‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
// ============================================================================
handleDeleteProfile({ id, name, imagePath }) {
  UI.showModal({
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
    message: `‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á <strong>${name}</strong>? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
    onConfirm: async () => {
      UI.showToast(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö ${name}...`, 'info');
      
      try {
        const { error } = await supabase
          .from('profiles')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        // ‚úÖ ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Storage ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (imagePath && imagePath !== 'null' && imagePath.trim() !== '') {
          const { error: storageError } = await supabase.storage
            .from(STORAGE_BUCKET)
            .remove([imagePath]);
          
          if (storageError) {
            console.warn("Failed to delete image from storage:", storageError.message);
          }
        }
        
        UI.showToast('‡∏•‡∏ö‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        await this.fetchData();
        this.renderView(AppState.currentView, AppState.currentParams);
      } catch (error) {
        UI.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`, "error");
      }
    }
  });
},
  
  renderProvincesManagementContainer() {
    DOM.viewContent.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h4 class="text-lg font-semibold text-indigo-700 mb-4 border-b pb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</h4>
          <form id="add-province-form" class="space-y-4">
            <div>
              <label for="province-name-thai" class="block text-sm font-medium text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠ (‡πÑ‡∏ó‡∏¢)*</label>
              <input type="text" id="province-name-thai" required class="form-input">
            </div>
            <div>
              <label for="province-key" class="block text-sm font-medium text-slate-700 mb-1">‡∏Ñ‡∏µ‡∏¢‡πå (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)*</label>
              <input type="text" id="province-key" required class="form-input" placeholder="english-no-space">
              <p class="text-xs text-slate-500 mt-1">‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ</p>
            </div>
            <button type="submit" id="add-province-btn" class="w-full py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
              ‡πÄ‡∏û‡∏¥‡πà‡∏°
            </button>
          </form>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg">
          <h4 class="text-lg font-semibold text-indigo-700 mb-4 border-b pb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
          <div class="overflow-x-auto">
            ${AppState.provinces.length === 0 ? 
              '<p class="text-center py-8 text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>' : 
              `<table class="min-w-full">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">‡∏Ñ‡∏µ‡∏¢‡πå</th>
                    <th class="px-4 py-3 text-right"></th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                  ${AppState.provinces.map(p => `
                    <tr>
                      <td class="px-4 py-3 text-sm text-slate-700">${p.nameThai}</td>
                      <td class="px-4 py-3 text-sm font-mono text-slate-500">${p.key}</td>
                      <td class="px-4 py-3 text-right">
                        <button data-id="${p.id}" data-name="${p.nameThai}" class="delete-province-btn text-red-500 hover:text-red-700">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>`
            }
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('add-province-form').addEventListener('submit', e => this.handleAddProvince(e));
  },
  
  async handleAddProvince(e) {
    e.preventDefault();
    const form = e.target;
    const nameThai = form.querySelector('#province-name-thai').value.trim();
    const key = form.querySelector('#province-key').value.trim().toLowerCase().replace(/\s+/g, '-');
    
    if (!nameThai || !key) {
      UI.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
      return;
    }
    
    const saveButton = form.querySelector('#add-province-btn');
    UI.toggleButtonLoading(saveButton, true, '‡πÄ‡∏û‡∏¥‡πà‡∏°');
    
    try {
      const { error } = await supabase
        .from('provinces')
        .insert([{ nameThai, key }]);
      
      if (error) throw error;
      
      UI.showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      form.reset();
      await this.fetchData();
      this.renderView('provinces-management-container');
    } catch (error) {
      UI.showToast(`‡πÄ‡∏Å‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
    } finally {
      UI.toggleButtonLoading(saveButton, false, '‡πÄ‡∏û‡∏¥‡πà‡∏°');
    }
  },
  
  handleDeleteProvince({ id, name }) {
    UI.showModal({
      title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
      message: `‡∏à‡∏∞‡∏•‡∏ö <strong>${name}</strong>?`,
      onConfirm: async () => {
        try {
          const { error } = await supabase
            .from('provinces')
            .delete()
            .eq('id', id);
          
          if (error) throw error;
          
          UI.showToast('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          await this.fetchData();
          this.renderView('provinces-management-container');
        } catch (error) {
          UI.showToast(`‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
        }
      }
    });
  }
};

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
  Controller.setupEventListeners();
  Controller.initApp();
});
</script>
<script>
// Multi-image Preview Enhancer
(function(){
  function byId(id){ return document.getElementById(id); }
  const input = byId('image-file-input');
  const preview = document.getElementById('multi-preview');
  if (!input || !preview) return;
  
  preview.innerHTML = '';
  input.addEventListener('change', () => {
    preview.innerHTML = '';
    const files = Array.from(input.files || []);
    files.forEach(file => {
      const url = URL.createObjectURL(file);
      const card = document.createElement('div');
      card.className = 'relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01]';
      const img = document.createElement('img');
      img.src = url;
      img.alt = file.name;
      img.className = 'w-full h-32 object-cover';
      const badge = document.createElement('div');
      badge.className = 'absolute top-2 right-2 text-xs px-2 py-1 rounded-full bg-black/60 text-white backdrop-blur';
      badge.textContent = (file.type || '').replace('image/','').toUpperCase();
      card.appendChild(img);
      card.appendChild(badge);
      preview.appendChild(card);
    });
  }, { once:false });
})();

// Rehydrate multi-preview from existing imagePaths
(function(){
  const preview = document.getElementById('multi-preview');
  if (!preview) return;
  const form = document.getElementById('profile-form') || document.querySelector('form');
  if (!form) return;
  
  const currentSingle = form.querySelector('#current-image-path')?.value;
  let embedded = null;
  try { embedded = window.__CURRENT_PROFILE__ || null; } catch(_) {}
  
  const paths = (embedded && embedded.imagePaths) ? embedded.imagePaths
                : (currentSingle ? [currentSingle] : []);
  
  if (paths && paths.length) {
    preview.innerHTML = '';
    paths.forEach(p => {
      const card = document.createElement('div');
      card.className = 'relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01]';
      const img = document.createElement('img');
      img.src = (typeof CDN_PUBLIC_URL !== 'undefined' ? CDN_PUBLIC_URL : '') + p;
      img.className = 'w-full h-32 object-cover';
      card.appendChild(img);
      preview.appendChild(card);
    });
  }
})();

// Auto-close sidebar on navigation (mobile)
(function(){
  const mq = window.matchMedia('(max-width: 1024px)');
  const closeSidebar = () => {
    try {
      AppState.isSidebarOpen = false;
      document.documentElement.classList.remove('overflow-hidden');
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.add('-translate-x-full');
    } catch(_) {}
  };
  
  const nav = document.getElementById('sidebar') || document;
  nav.addEventListener('click', (e) => {
    const el = e.target.closest('a,[data-nav],[data-action="navigate"]');
    if (!el) return;
    if (mq.matches) setTimeout(closeSidebar, 50);
  });
  
  const origRenderView = (window.App && App.renderView) || null;
  if (origRenderView) {
    App.renderView = (...args) => {
      const res = origRenderView.apply(App, args);
      if (mq.matches) closeSidebar();
      return res;
    };
  }
})();

// Advanced Multi-Preview: drag & drop, remove items, limit, de-dup
(function(){
  const input = document.getElementById('image-file-input');
  const preview = document.getElementById('multi-preview');
  if (!input || !preview) return;
  
  const dropArea = input.closest('.relative') || preview.parentElement;
  const MAX_FILES = 20;
  const MAX_SIZE = 10 * 1024 * 1024; // 10MB
  
  const dedup = (files) => {
    const seen = new Set();
    const out = [];
    for (const f of files) {
      const key = `${f.name}|${f.size}|${f.lastModified}`;
      if (!seen.has(key)) {
        seen.add(key);
        out.push(f);
      }
    }
    return out;
  };
  
  const rebuildInputFiles = (files) => {
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    input.files = dt.files;
  };
  
  const render = () => {
    preview.innerHTML = '';
    const files = Array.from(input.files || []);
    
    files.forEach((file, idx) => {
      const url = URL.createObjectURL(file);
      const card = document.createElement('div');
      card.className = 'group relative rounded-xl overflow-hidden shadow hover:shadow-lg transition transform hover:scale-[1.01] subtle-pop';
      
      const img = document.createElement('img');
      img.src = url;
      img.alt = file.name;
      img.className = 'w-full h-32 object-cover';
      
      const topbar = document.createElement('div');
      topbar.className = 'absolute inset-x-0 top-0 flex justify-between p-2 opacity-0 group-hover:opacity-100 transition';
      
      const badge = document.createElement('div');
      badge.className = 'text-[10px] px-2 py-1 rounded-full bg-black/60 text-white backdrop-blur';
      badge.textContent = (file.type || '').replace('image/','').toUpperCase();
      
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'text-white bg-red-500/80 hover:bg-red-600 text-xs px-2 py-1 rounded';
      del.textContent = '‡∏•‡∏ö';
      del.addEventListener('click', () => {
        const arr = Array.from(input.files);
        arr.splice(idx, 1);
        rebuildInputFiles(arr);
        render();
      });
      
      topbar.appendChild(badge);
      topbar.appendChild(del);
      card.appendChild(img);
      card.appendChild(topbar);
      preview.appendChild(card);
    });
  };
  
  const accept = (files) => {
    let current = Array.from(input.files || []);
    const newList = [];
    
    for (const f of files) {
      if (!/^image\//i.test(f.type)) continue;
      if (f.size > MAX_SIZE) {
        UI && UI.showToast ? UI.showToast(`‡πÑ‡∏ü‡∏•‡πå ${f.name} ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB`, 'warning') : console.warn('oversize', f.name);
        continue;
      }
      newList.push(f);
    }
    
    current = current.concat(newList);
    current = dedup(current).slice(0, MAX_FILES);
    rebuildInputFiles(current);
    render();
  };
  
  input.addEventListener('change', () => accept(Array.from(input.files || [])));
  
  if (dropArea) {
    ['dragenter','dragover'].forEach(ev => {
      dropArea.addEventListener(ev, e => {
        e.preventDefault();
        dropArea.classList.add('ring-2','ring-indigo-400');
      });
    });
    
    ['dragleave','drop'].forEach(ev => {
      dropArea.addEventListener(ev, e => {
        e.preventDefault();
        dropArea.classList.remove('ring-2','ring-indigo-400');
      });
    });
    
    dropArea.addEventListener('drop', (e) => {
      const files = Array.from(e.dataTransfer.files || []);
      accept(files);
    });
  }
  
  render();
})();
</script>

<!-- Theme Toggle -->
<div class="toggle-wrap">
  <button id="theme-toggle" class="theme-toggle">‡∏™‡∏•‡∏±‡∏ö‡∏ò‡∏µ‡∏°</button>
</div>

<script>
// Theme Toggle Functionality
(function(){
  const btn = document.getElementById('theme-toggle');
  if (!btn) return;
  
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  
  if (saved) {
    root.setAttribute('data-theme', saved);
  } else {
    root.setAttribute('data-theme', 'light');
  }
  
  btn.addEventListener('click', () => {
    const cur = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', cur);
    localStorage.setItem('theme', cur);
  });
})();

// Lazy Load Images
(function(){
  function onLoad(e) {
    e.target.classList.add('lazyloaded');
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('img').forEach(img => {
      img.loading = 'lazy';
      img.classList.add('blur-up');
      
      if (img.complete) {
        img.classList.add('lazyloaded');
      } else {
        img.addEventListener('load', onLoad, { once: true });
      }
    });
  });
})();
</script>

<!-- Cropper Modal -->
<div id="cropper-modal">
  <div id="cropper-box" class="card-surface">
    <h3 class="text-lg font-semibold mb-2">‡∏Ñ‡∏£‡∏≠‡∏õ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
    <canvas id="crop-canvas"></canvas>
    <div class="flex flex-wrap gap-2 mt-3">
      <button class="btn-primary" data-aspect="1">1:1</button>
      <button class="btn-primary" data-aspect="0.8">4:5</button>
      <button class="btn-primary" data-aspect="1.7777777778">16:9</button>
      <button id="crop-apply" class="btn-primary">‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏õ</button>
      <button id="crop-cancel" class="btn-primary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>
</div>

<script>
// Image Cropper Functionality
(function(){
  const input = document.getElementById('image-file-input');
  const preview = document.getElementById('deluxe-preview');
  if (!input || !preview) return;
  
  function rebuild(files) {
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    input.files = dt.files;
  }
  
  function equip() {
    Array.from(preview.children).forEach((card, i) => {
      card.classList.add('reorder-card');
      card.setAttribute('draggable','true');
      
      if (!card.querySelector('.btn-crop')) {
        const bar = card.querySelector('.absolute.inset-x-0.top-0');
        const cropBtn = document.createElement('button');
        cropBtn.type = 'button';
        cropBtn.textContent = '‡∏Ñ‡∏£‡∏≠‡∏õ';
        cropBtn.className = 'btn-crop text-white bg-indigo-500/90 hover:bg-indigo-600 text-xs px-2 py-1 rounded';
        bar.appendChild(cropBtn);
        cropBtn.addEventListener('click', () => openCrop(i));
      }
      
      card.addEventListener('dragstart', ev => {
        ev.dataTransfer.setData('text/plain', i.toString());
        ev.dataTransfer.effectAllowed = 'move';
      });
      
      card.addEventListener('dragover', ev => {
        ev.preventDefault();
        ev.dataTransfer.dropEffect = 'move';
      });
      
      card.addEventListener('drop', ev => {
        ev.preventDefault();
        const from = parseInt(ev.dataTransfer.getData('text/plain'),10);
        const arr = Array.from(input.files);
        const [moved] = arr.splice(from,1);
        arr.splice(i,0,moved);
        rebuild(arr);
        input.dispatchEvent(new Event('change'));
      });
    });
  }
  
  const modal = document.getElementById('cropper-modal');
  const canvas = document.getElementById('crop-canvas');
  const ctx = canvas.getContext('2d');
  
  let cropState = {
    img: null,
    aspect: 1,
    fileIndex: 0,
    bmp: null,
    sel: { x: 0, y: 0, w: 0, h: 0 }
  };
  
  function openCrop(index) {
    const file = Array.from(input.files)[index];
    cropState.fileIndex = index;
    
    createImageBitmap(file, { imageOrientation: 'from-image' }).then(bmp => {
      cropState.bmp = bmp;
      canvas.width = Math.min(1024, bmp.width);
      canvas.height = Math.min(600, Math.round(canvas.width * (bmp.height/bmp.width)));
      drawCrop();
      modal.classList.add('active');
    });
  }
  
  function drawCrop() {
    const bmp = cropState.bmp;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
    
    const asp = cropState.aspect || 1;
    let w = canvas.width * 0.8;
    let h = w / asp;
    
    if (h > canvas.height * 0.8) {
      h = canvas.height * 0.8;
      w = h * asp;
    }
    
    const x = (canvas.width - w) / 2;
    const y = (canvas.height - h) / 2;
    cropState.sel = { x, y, w, h };
    
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(0, 0, canvas.width, y);
    ctx.fillRect(0, y + h, canvas.width, canvas.height - (y + h));
    ctx.fillRect(0, y, w, y + h - y);
    ctx.fillRect(x + w, y, canvas.width - (x + w), h);
    
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, w, h);
  }
  
  document.querySelectorAll('#cropper-box [data-aspect]').forEach(btn => {
    btn.addEventListener('click', () => {
      cropState.aspect = parseFloat(btn.dataset.aspect);
      drawCrop();
    });
  });
  
  document.getElementById('crop-cancel').addEventListener('click', () => {
    modal.classList.remove('active');
  });
  
  document.getElementById('crop-apply').addEventListener('click', async () => {
    const scale = cropState.bmp.width / canvas.width;
    const s = cropState.sel;
    const cw = Math.round(s.w * scale);
    const ch = Math.round(s.h * scale);
    
    const c = document.createElement('canvas');
    c.width = cw;
    c.height = ch;
    
    c.getContext('2d').drawImage(
      cropState.bmp,
      Math.round(s.x * scale),
      Math.round(s.y * scale),
      cw, ch,
      0, 0, cw, ch
    );
    
    const blob = await new Promise(res => c.toBlob(res, 'image/webp', 0.95));
    const file = new File([blob], 'cropped.webp', {
      type: 'image/webp',
      lastModified: Date.now()
    });
    
    const arr = Array.from(input.files);
    arr.splice(cropState.fileIndex, 1, file);
    rebuild(arr);
    input.dispatchEvent(new Event('change'));
    modal.classList.remove('active');
  });
  
  const observer = new MutationObserver(equip);
  observer.observe(preview, { childList: true, subtree: false });
  equip();
})();
</script>
<!-- ================================================================================== -->
<!-- üéµ ULTIMATE ADMIN WIDGET (iOS Style + Magnetic + Media Center) -->
<!-- ================================================================================== -->

<!-- 1. Import Vidstack (Engine ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏•‡∏Å) -->
<link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
<link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />
<script type="module" src="https://cdn.vidstack.io/player"></script>

<style>
  /* --- High-End CSS Variables (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡∏ß‡∏¢‡∏î‡∏µ) --- */
  :root {
    --widget-size: 60px;
    --widget-bg: rgba(255, 255, 255, 0.75);
    --widget-blur: blur(20px) saturate(180%);
    --widget-shadow: 0 12px 30px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0,0,0,0.05);
    --primary-gradient: linear-gradient(135deg, #FF6F61, #D667C3);
  }

  /* --- Widget Container (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å) --- */
  #admin-assistive-root {
    position: fixed; 
    z-index: 999999; /* ‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î */
    top: 70%; left: 80%;
    touch-action: none; /* ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∑‡∏°‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏•‡∏≤‡∏Å‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ */
    user-select: none;
    -webkit-user-select: none;
  }

  /* --- Floating Button --- */
  .assistive-btn {
    width: var(--widget-size); height: var(--widget-size);
    background: var(--widget-bg);
    backdrop-filter: var(--widget-blur); -webkit-backdrop-filter: var(--widget-blur);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    box-shadow: var(--widget-shadow);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; position: relative;
    /* ‡πÄ‡∏≠‡∏≤ transition ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ï‡∏≠‡∏ô‡∏•‡∏≤‡∏Å */
  }
  
  .assistive-btn:active { transform: scale(0.92); }
  .assistive-btn i { font-size: 24px; color: #FF6F61; }
  
  /* --- Animation ‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏°‡∏∑‡∏≠ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) --- */
  /* ‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å JS ‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏°‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡∏≠‡∏ö‡∏ô‡∏∏‡πà‡∏°‡πÜ */
  .snap-transition {
    transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), top 0.3s ease !important;
  }

  /* --- Pulse Animation --- */
  .playing-pulse::before {
    content: ''; position: absolute; inset: -4px; border-radius: 50%;
    border: 2px solid #FF6F61; opacity: 0;
    animation: pulse-ring 2s infinite;
  }
  @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }

  /* --- Panel (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π) --- */
  .control-center-panel {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
    width: 90%; max-width: 420px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(40px);
    border-radius: 24px;
    box-shadow: 0 40px 80px rgba(0,0,0,0.3);
    padding: 24px;
    opacity: 0; pointer-events: none; z-index: 100001;
    transition: all 0.3s ease;
    display: flex; flex-direction: column; gap: 15px;
  }
  .control-center-panel.active { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }

  /* --- Media Areas --- */
  .video-frame {
    width: 100%; aspect-ratio: 16/9; background: #000; border-radius: 12px;
    overflow: hidden; display: none; 
  }
  .video-frame iframe, .video-frame video { width: 100%; height: 100%; border: none; }

  .music-cover {
    width: 120px; height: 120px; margin: 0 auto;
    border-radius: 20px; overflow: hidden;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    position: relative;
  }
  .music-cover img { width: 100%; height: 100%; object-fit: cover; }
  
  /* --- Controls --- */
  .media-input {
    width: 100%; background: #f0f0f5; border: 1px solid #e0e0e0;
    padding: 10px 15px; border-radius: 10px; outline: none; text-align: center;
  }
  .preset-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .preset-btn {
    padding: 8px; background: #fff; border: 1px solid #eee; border-radius: 8px;
    font-size: 13px; color: #555; cursor: pointer; transition: all 0.2s;
  }
  .preset-btn:hover { background: #FF6F61; color: #fff; border-color: #FF6F61; }
  .preset-btn.highlight { background: #D667C3; color: white; border-color: #D667C3; }

  .close-btn {
    position: absolute; top: 15px; right: 15px;
    width: 30px; height: 30px; border-radius: 50%; background: #eee;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }
</style>
<div id="admin-assistive-root">
  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î -->
  <div class="assistive-btn" id="assistive-main-btn">
    <i class="fas fa-music"></i>
  </div>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
<div class="control-center-panel" id="admin-control-panel">
  <div class="close-btn" onclick="AdminOS.closePanel()"><i class="fas fa-times"></i></div>
  
  <div class="text-center">
    <h3 class="font-bold text-gray-800">Media Center</h3>
    <p class="text-xs text-gray-500">Video & Music Player</p>
  </div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Video -->
  <div id="video-display-area" class="video-frame"></div>

  <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Music -->
  <div id="music-display-area">
    <div class="music-cover mb-4">
      <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=400&q=80" id="album-art-img">
    </div>
  </div>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å Link -->
  <input type="text" class="media-input" id="media-url-input" 
         placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏´‡∏£‡∏∑‡∏≠ MP3 ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter..." 
         onkeypress="if(event.key === 'Enter') AdminOS.playFromInput(this.value)">

<div class="preset-grid">
    <!-- üéµ ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤ (‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö) -->
    <button class="preset-btn highlight" onclick="AdminOS.playMedia('https://youtu.be/MLB7JKDmYnM', 'youtube')">
        üéß ‡πÄ‡∏û‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (YouTube)
    </button>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏£‡∏≠‡∏á (Lofi Girl) -->
    <button class="preset-btn" onclick="AdminOS.playMedia('https://www.youtube.com/watch?v=jfKfPfyJRdk', 'youtube')">
        ‚òï Lofi Girl
    </button>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -->
    <button class="preset-btn" onclick="document.getElementById('local-file-picker').click()">
        üìÇ ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
    </button>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏¢‡∏∏‡∏î -->
    <button class="preset-btn" style="color: red;" onclick="AdminOS.stopAll()">
        ‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏•‡πà‡∏ô
    </button>
</div>
  
  <input type="file" id="local-file-picker" hidden accept="audio/*,video/*" onchange="AdminOS.playLocalFile(this)">
</div>
<script>
const AdminOS = {
  root: document.getElementById('admin-assistive-root'),
  btn: document.getElementById('assistive-main-btn'),
  panel: document.getElementById('admin-control-panel'),
  videoArea: document.getElementById('video-display-area'),
  musicArea: document.getElementById('music-display-area'),
  audioPlayer: new Audio(),
  
  isDragging: false, // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°

  init() {
    // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
    this.setupDraggable();

    // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î (‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏Å)
    this.btn.addEventListener('click', (e) => {
      if (!this.isDragging) {
        this.panel.classList.toggle('active');
      }
    });

    // 3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Player
    this.audioPlayer.addEventListener('play', () => this.btn.classList.add('playing-pulse'));
    this.audioPlayer.addEventListener('pause', () => this.btn.classList.remove('playing-pulse'));
  },

  closePanel() { this.panel.classList.remove('active'); },

  stopAll() {
    this.videoArea.innerHTML = ''; 
    this.videoArea.style.display = 'none';
    this.audioPlayer.pause(); 
    this.audioPlayer.currentTime = 0;
    if(this.musicArea) this.musicArea.style.display = 'block';
    this.btn.classList.remove('playing-pulse');
  },

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏∑‡πà‡∏≠ (YouTube / Video / Audio)
  playFromInput(url) {
    url = url.trim();
    if (!url) return;
    if (url.includes('youtube.com') || url.includes('youtu.be')) {
      this.playMedia(url, 'youtube');
    } else if (url.match(/\.(mp4|webm|ogg)$/i)) {
      this.playMedia(url, 'video'); // ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö Video File
    } else {
      this.playMedia(url, 'audio'); // ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    }
  },

  playMedia(source, type) {
    this.stopAll();
    
    if (type === 'youtube') {
      // ‡∏î‡∏∂‡∏á ID ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube
      let vId = '';
      if (source.includes('youtu.be')) {
        vId = source.split('/').pop().split('?')[0];
      } else if (source.includes('v=')) {
        vId = source.split('v=')[1].split('&')[0];
      }

      this.videoArea.style.display = 'block';
      if(this.musicArea) this.musicArea.style.display = 'none';
      
      // Iframe Youtube ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
      this.videoArea.innerHTML = `<iframe src="https://www.youtube.com/embed/${vId}?autoplay=1&playsinline=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
      this.btn.classList.add('playing-pulse');

    } else if (type === 'video') {
       // ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå Video MP4
       this.videoArea.style.display = 'block';
       if(this.musicArea) this.musicArea.style.display = 'none';
       this.videoArea.innerHTML = `<video src="${source}" controls autoplay style="width:100%; height:100%"></video>`;
       this.btn.classList.add('playing-pulse');

    } else {
      // ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏ü‡∏•‡πå Audio
      if(this.musicArea) this.musicArea.style.display = 'block';
      this.audioPlayer.src = source;
      this.audioPlayer.play().catch(e => console.error(e));
    }
  },

  playLocalFile(input) {
    const file = input.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      if (file.type.startsWith('video')) {
        this.playMedia(url, 'video');
      } else {
        this.playMedia(url, 'audio');
      }
    }
  },

  // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö iPhone (AssistiveTouch Logic) ---
  setupDraggable() {
    const el = this.root;
    let startX, startY, initialLeft, initialTop;
    let hasMoved = false;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ï‡∏∞
    const onStart = (e) => {
      const evt = e.type === 'touchstart' ? e.touches[0] : e;
      startX = evt.clientX;
      startY = evt.clientY;
      const rect = el.getBoundingClientRect();
      initialLeft = rect.left;
      initialTop = rect.top;
      hasMoved = false;
      this.isDragging = false;
      
      // ‡πÄ‡∏≠‡∏≤ Animation ‡∏≠‡∏≠‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏ï‡∏¥‡∏î‡∏ô‡∏¥‡πâ‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
      el.classList.remove('snap-transition');
      
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchend', onEnd);
      document.addEventListener('mouseup', onEnd);
    };

    // ‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤‡∏Å
    const onMove = (e) => {
      const evt = e.type === 'touchmove' ? e.touches[0] : e;
      const dx = evt.clientX - startX;
      const dy = evt.clientY - startY;

      // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏¢‡∏±‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô 5px ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏•‡∏≤‡∏Å
      if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
        if (e.cancelable) e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Scroll
        hasMoved = true;
        this.isDragging = true;
        
        // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡πâ‡∏ß
        el.style.left = `${initialLeft + dx}px`;
        el.style.top = `${initialTop + dy}px`;
      }
    };

    // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏°‡∏∑‡∏≠
    const onEnd = () => {
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('touchend', onEnd);
      document.removeEventListener('mouseup', onEnd);

      if (hasMoved) {
        // ‡πÉ‡∏™‡πà Animation ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏ô‡∏∏‡πà‡∏°‡πÜ)
        el.classList.add('snap-transition'); 
        
        const screenW = window.innerWidth;
        const rect = el.getBoundingClientRect();
        const centerX = rect.left + (rect.width / 2);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏à‡∏≠‡∏Ç‡∏ß‡∏≤ -> ‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏ß‡∏≤, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô -> ‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≤‡∏¢
        if (centerX > screenW / 2) {
          el.style.left = `${screenW - 70}px`; 
        } else {
          el.style.left = `10px`; 
        }

        // ‡∏Å‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏∏‡∏î‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô/‡∏•‡πà‡∏≤‡∏á
        if (rect.top < 0) el.style.top = '10px';
        if (rect.bottom > window.innerHeight) el.style.top = `${window.innerHeight - 70}px`;
        
        // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏Ñ‡πà‡∏≠‡∏¢‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏•‡∏≤‡∏Å (‡∏Å‡∏±‡∏ô Click ‡∏ã‡πâ‡∏≠‡∏ô)
        setTimeout(() => { this.isDragging = false; }, 100);
      }
    };

    el.addEventListener('touchstart', onStart, { passive: false });
    el.addEventListener('mousedown', onStart);
  }
};

AdminOS.init();
</script>
</body>
</html>